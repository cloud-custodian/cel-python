<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Application Integration &#8212; CEL in Python  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Architecture and Design" href="structure.html" />
    <link rel="prev" title="Configuration" href="configuration.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="application-integration">
<span id="integration"></span><h1>Application Integration<a class="headerlink" href="#application-integration" title="Link to this heading">¶</a></h1>
<p>We’ll look at integration of CEL into another application from four perspectives:</p>
<ol class="arabic simple">
<li><p>We’ll start with <a class="reference internal" href="#integration-essentials">Integration Essentials</a>. This is the base case for integration into another application.</p></li>
<li><p>In <a class="reference internal" href="#function-bindings">Function Bindings</a>, we’ll look at a more sophisticated integration. This extends the environment with custom functions.
This can provide a well-defined interface between CEL expressions and your application’s functionality.</p></li>
<li><p><a class="reference internal" href="#more-examples-from-the-go-implementation">More Examples from the Go implementation</a> shows how extend the environment using new types.
Python’s use of duck typing removes some of the complexity of the Go implementation.</p></li>
<li><p>There are a few exception and error-handling cases covered in <a class="reference internal" href="#exceptions-and-errors">Exceptions and Errors</a>.</p></li>
<li><p>The <a class="reference internal" href="#cloud-custodian-c7n-integration">Cloud Custodian (C7N) Integration</a> is rather complicated because the C7N is covers quite a large number of distinct data types.</p></li>
</ol>
<ol class="arabic simple" start="5">
<li><p>Finally, <a class="reference internal" href="#external-api">External API</a> will review some elements of the API that are part of the integration interface.</p></li>
</ol>
<section id="integration-essentials">
<h2>Integration Essentials<a class="headerlink" href="#integration-essentials" title="Link to this heading">¶</a></h2>
<p>Here’s an example of variable bindings taken from a <code class="docutils literal notranslate"><span class="pre">README</span></code> example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">celpy</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cel_source</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="s2">account.balance &gt;= transaction.withdrawal</span>
<span class="gp">... </span><span class="s2">|| (account.overdraftProtection</span>
<span class="gp">... </span><span class="s2">&amp;&amp; account.overdraftLimit &gt;= transaction.withdrawal - account.balance)</span>
<span class="gp">... </span><span class="s2">&quot;&quot;&quot;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">env</span> <span class="o">=</span> <span class="n">celpy</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ast</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">cel_source</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">prgm</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">program</span><span class="p">(</span><span class="n">ast</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s2">&quot;account&quot;</span><span class="p">:</span> <span class="n">celpy</span><span class="o">.</span><span class="n">json_to_cel</span><span class="p">({</span><span class="s2">&quot;balance&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;overdraftProtection&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}),</span>
<span class="gp">... </span>    <span class="s2">&quot;transaction&quot;</span><span class="p">:</span> <span class="n">celpy</span><span class="o">.</span><span class="n">json_to_cel</span><span class="p">({</span><span class="s2">&quot;withdrawal&quot;</span><span class="p">:</span> <span class="mi">600</span><span class="p">})</span>
<span class="gp">... </span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">prgm</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span>
<span class="go">BoolType(False)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">cel_source</span></code> is an expression to be evaluated.
This references variables with names like <code class="docutils literal notranslate"><span class="pre">account</span></code>, and <code class="docutils literal notranslate"><span class="pre">transaction</span></code>.</p>
<p>All CEL evaluation uses an <code class="xref py py-class docutils literal notranslate"><span class="pre">celpy.Environment</span></code> object.
The <code class="xref py py-class docutils literal notranslate"><span class="pre">celpy.Environment</span></code> is used to provide type annotations for variables.
It can provide a few other properties, including an overall package name, sometimes needed when working with protobuf types.</p>
<p>The <code class="xref py py-meth docutils literal notranslate"><span class="pre">Environment.compile()</span></code> method creates a abstract syntax tree from the CEL source.
This will be used to create a final program to evaluate.
This method can raise the <code class="xref py py-exc docutils literal notranslate"><span class="pre">CELSyntaxError</span></code> exception.</p>
<p>The <code class="xref py py-meth docutils literal notranslate"><span class="pre">Environment.program()</span></code> method creates a runner out of an abstract syntax tree.</p>
<p>Compiling and building a program is a two-step process to permit optimization or some other transformation the AST prior to evaluation.
The Lark parser (<a class="reference external" href="https://lark-parser.readthedocs.io/en/latest/classes.html">https://lark-parser.readthedocs.io/en/latest/classes.html</a>) is used, and transformers are a first-class feature of this parser.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">context</span></code> mapping defines variables and provides their values.
This is used to evaluate the resulting program object.
The program will produce a value defined in the <a class="reference internal" href="api.html#module-celpy.celtypes" title="celpy.celtypes"><code class="xref py py-mod docutils literal notranslate"><span class="pre">celpy.celtypes</span></code></a> module.
In this example, it’s a <a class="reference internal" href="api.html#celpy.celtypes.BoolType" title="celpy.celtypes.BoolType"><code class="xref py py-mod docutils literal notranslate"><span class="pre">celpy.celtypes.BoolType</span></code></a> value.</p>
<p>The CEL types are all specializations of the obvious Python base types.
To an extent, these Python classes are partially based on the object model in <a class="reference external" href="https://github.com/google/cel-go">https://github.com/google/cel-go</a>.
We don’t need all the Go formalisms, however, and rely on Pythonic variants.</p>
<section id="simple-example-using-builtin-types">
<h3>Simple example using builtin types<a class="headerlink" href="#simple-example-using-builtin-types" title="Link to this heading">¶</a></h3>
<p>Here’s an example taken from
<a class="reference external" href="https://github.com/google/cel-go/blob/master/examples/README.md">https://github.com/google/cel-go/blob/master/examples/README.md</a>.
This will evaluate the CEL expression <code class="docutils literal notranslate"><span class="pre">&quot;Hello</span> <span class="pre">world!</span> <span class="pre">I'm</span> <span class="pre">&quot;</span> <span class="pre">+</span> <span class="pre">name</span> <span class="pre">+</span> <span class="pre">&quot;.&quot;</span></code> with <code class="docutils literal notranslate"><span class="pre">&quot;CEL&quot;</span></code> passed as the <code class="docutils literal notranslate"><span class="pre">name</span></code> variable.</p>
<p>This is the original Go code:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;github.com/google/cel-go/cel&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/google/cel-go/checker/decls&quot;</span>
<span class="p">)</span>

<span class="nx">d</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cel</span><span class="p">.</span><span class="nx">Declarations</span><span class="p">(</span><span class="nx">decls</span><span class="p">.</span><span class="nx">NewVar</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">decls</span><span class="p">.</span><span class="nx">String</span><span class="p">))</span>
<span class="nx">env</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cel</span><span class="p">.</span><span class="nx">NewEnv</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>

<span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="nx">iss</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">env</span><span class="p">.</span><span class="nx">Compile</span><span class="p">(</span><span class="s">`&quot;Hello world! I&#39;m &quot; + name + &quot;.&quot;`</span><span class="p">)</span>
<span class="c1">// Check iss for compilation errors.</span>
<span class="k">if</span><span class="w"> </span><span class="nx">iss</span><span class="p">.</span><span class="nx">Err</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatalln</span><span class="p">(</span><span class="nx">iss</span><span class="p">.</span><span class="nx">Err</span><span class="p">())</span>
<span class="p">}</span>
<span class="nx">prg</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">env</span><span class="p">.</span><span class="nx">Program</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span>
<span class="nx">out</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">prg</span><span class="p">.</span><span class="nx">Eval</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
<span class="w">    </span><span class="s">&quot;name&quot;</span><span class="p">:</span><span class="w">   </span><span class="s">&quot;CEL&quot;</span><span class="p">,</span>
<span class="p">})</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span>
<span class="c1">// Output:Hello world! I&#39;m CEL.</span>
</pre></div>
</div>
<p>Here’s the Python version, following a similar outline:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">celpy</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cel_source</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="s2">&quot;Hello world! I&#39;m &quot; + name + &quot;.&quot;</span>
<span class="gp">... </span><span class="s2">&quot;&quot;&quot;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">decls</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">celpy</span><span class="o">.</span><span class="n">celtypes</span><span class="o">.</span><span class="n">StringType</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">env</span> <span class="o">=</span> <span class="n">celpy</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">annotations</span><span class="o">=</span><span class="n">decls</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ast</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">cel_source</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">prgm</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">program</span><span class="p">(</span><span class="n">ast</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;CEL&quot;</span>
<span class="gp">... </span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">prgm</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span>
<span class="go">&quot;Hello world! I&#39;m CEL.&quot;</span>
</pre></div>
</div>
<p>The steps include:</p>
<ol class="arabic simple">
<li><p>Create a <code class="xref py py-class docutils literal notranslate"><span class="pre">celpy.Environment</span></code> with annotations for any variables.
These kinds of type definitions are atypical for Python, but are part of the definition of the CEL language.</p></li>
<li><p>Use <code class="xref py py-meth docutils literal notranslate"><span class="pre">celpy.Environment.compile()</span></code> to create an AST.</p></li>
<li><p>Use <code class="xref py py-meth docutils literal notranslate"><span class="pre">celpy.Environment.program()</span></code> to build a <code class="xref py py-class docutils literal notranslate"><span class="pre">celpy.Runner</span></code> object that will do the final evaluation. This includes the environment and the AST.</p></li>
<li><p>Use <code class="xref py py-meth docutils literal notranslate"><span class="pre">celpy.Runner.evaluate()</span></code> to evaluate the program with specific values for the defined variables.</p></li>
</ol>
<p>In the Go world, there’s a formal type adapter to convert input values to the objects used by CEL.
For numerous types, a default adapter handles this.</p>
<p>In Python, on the other hand, we define the type conversions as features of the Python versions of the CEL types.
This approach fits better with native Python programming.</p>
</section>
</section>
<section id="function-bindings">
<h2>Function Bindings<a class="headerlink" href="#function-bindings" title="Link to this heading">¶</a></h2>
<p>There are two function binding examples in
<a class="reference external" href="https://github.com/google/cel-go/blob/master/examples/README.md">https://github.com/google/cel-go/blob/master/examples/README.md</a>.</p>
<p>There is a complication here that based on the way the Go resolves overloaded functions.
In Go, each overload of a function is described by a <code class="docutils literal notranslate"><span class="pre">(&quot;name&quot;,</span> <span class="pre">[args],</span> <span class="pre">result)</span></code> data structure.
The key of <code class="docutils literal notranslate"><span class="pre">(&quot;name&quot;,</span> <span class="pre">[args],</span> <span class="pre">result)</span></code> maps to a specific <code class="docutils literal notranslate"><span class="pre">arg_name_arg()</span></code> or <code class="docutils literal notranslate"><span class="pre">name_arg()</span></code> overloaded implementation for specific argument types.
This allows for multiple type-specific overload versions of a generic function.</p>
<p>For example, a <code class="docutils literal notranslate"><span class="pre">(&quot;greet&quot;,</span> <span class="pre">[StringType,</span> <span class="pre">StringType],</span> <span class="pre">StringType)</span></code> structure is expected to map to a function <code class="docutils literal notranslate"><span class="pre">string_greet_string()</span></code> that has the expected signature.</p>
<p>This is emphatically not how Python generally works.
We follow a more Pythonic approach is to provide a single, generic, function which examines the arguments and decides what to do.
Outside type-checking, Python doesn’t depend on overloaded name resolution.</p>
<p>This means a Python function must then sort out type variants and handle argument value coercion on its own.
For most cases, the <code class="docutils literal notranslate"><span class="pre">match/case</span></code> statement is helpful for this.
The <code class="xref py py-func docutils literal notranslate"><span class="pre">functools.singledispatch()</span></code> decorator can also be helpful for this.</p>
<p>The two examples have slightly different approaches to the CEL expression.
These are important in Go, but less important in Python.</p>
<section id="custom-function-in-go">
<h3>Custom function in Go<a class="headerlink" href="#custom-function-in-go" title="Link to this heading">¶</a></h3>
<p>We want to evaluate the CEL expression <code class="docutils literal notranslate"><span class="pre">i.greet(you)</span></code> with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">i</span>       <span class="o">-&gt;</span> <span class="n">CEL</span>
<span class="n">you</span>     <span class="o">-&gt;</span> <span class="n">world</span>
<span class="n">greet</span>   <span class="o">-&gt;</span> <span class="s2">&quot;Hello </span><span class="si">%s</span><span class="s2">! Nice to meet you, I&#39;m </span><span class="si">%s</span><span class="s2">.&quot;</span>
</pre></div>
</div>
<p>The idea here is the new <code class="docutils literal notranslate"><span class="pre">greet()</span></code> behaves like a method of a String.
The actual implementation, however, is not a method; it’s a function of two arguments.</p>
<p>First we need to declare two string variables and a <code class="docutils literal notranslate"><span class="pre">greet()</span></code> function.
In Go, a <code class="docutils literal notranslate"><span class="pre">NewInstanceOverload</span></code> must be used to provide annotations for variables and the function.
Here’s the Go implementation:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">decls</span><span class="p">.</span><span class="nx">NewVar</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">decls</span><span class="p">.</span><span class="nx">String</span><span class="p">),</span>
<span class="nx">decls</span><span class="p">.</span><span class="nx">NewVar</span><span class="p">(</span><span class="s">&quot;you&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">decls</span><span class="p">.</span><span class="nx">String</span><span class="p">),</span>
<span class="nx">decls</span><span class="p">.</span><span class="nx">NewFunction</span><span class="p">(</span><span class="s">&quot;greet&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">decls</span><span class="p">.</span><span class="nx">NewInstanceOverload</span><span class="p">(</span><span class="s">&quot;string_greet_string&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">[]</span><span class="o">*</span><span class="nx">exprpb</span><span class="p">.</span><span class="nx">Type</span><span class="p">{</span><span class="nx">decls</span><span class="p">.</span><span class="nx">String</span><span class="p">,</span><span class="w"> </span><span class="nx">decls</span><span class="p">.</span><span class="nx">String</span><span class="p">},</span>
<span class="w">        </span><span class="nx">decls</span><span class="p">.</span><span class="nx">String</span><span class="p">))</span>
<span class="o">...</span><span class="w"> </span><span class="c1">// Create env and compile</span>
</pre></div>
</div>
<p>We’ve omitted the Go details of creating an environment and compiling the CEL expression.
These aren’t different from the previous examples.</p>
<p>Separately, a <code class="docutils literal notranslate"><span class="pre">greetFunc()</span></code> function must be defined.
In Go, this function is then bound to the <code class="docutils literal notranslate"><span class="pre">&quot;string_greet_string&quot;</span></code> overload,
ready for evaluation.
Here’s the Go implementation:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">greetFunc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">functions</span><span class="p">.</span><span class="nx">Overload</span><span class="p">{</span>
<span class="w">    </span><span class="nx">Operator</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;string_greet_string&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">Binary</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">lhs</span><span class="w"> </span><span class="nx">ref</span><span class="p">.</span><span class="nx">Val</span><span class="p">,</span><span class="w"> </span><span class="nx">rhs</span><span class="w"> </span><span class="nx">ref</span><span class="p">.</span><span class="nx">Val</span><span class="p">)</span><span class="w"> </span><span class="nx">ref</span><span class="p">.</span><span class="nx">Val</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">types</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span>
<span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Hello %s! Nice to meet you, I&#39;m %s.\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">rhs</span><span class="p">,</span><span class="w"> </span><span class="nx">lhs</span><span class="p">))</span>
<span class="w">        </span><span class="p">}}</span>
<span class="nx">prg</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">env</span><span class="p">.</span><span class="nx">Program</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span><span class="w"> </span><span class="nx">cel</span><span class="p">.</span><span class="nx">Functions</span><span class="p">(</span><span class="nx">greetFunc</span><span class="p">))</span>

<span class="nx">out</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">prg</span><span class="p">.</span><span class="nx">Eval</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
<span class="w">    </span><span class="s">&quot;i&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;CEL&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;you&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;world&quot;</span><span class="p">,</span>
<span class="p">})</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span>
<span class="c1">// Output:Hello world! Nice to meet you, I&#39;m CEL.</span>
</pre></div>
</div>
<p>What’s essential is defining some type information, then defining variables and functions that fit those types.</p>
<p>The Python version has the same outline:</p>
<ol class="arabic simple">
<li><p>An <code class="xref py py-class docutils literal notranslate"><span class="pre">celpy.Environment</span></code> with type annotations for the two variables and the function.</p></li>
<li><p>Compile the source.</p></li>
</ol>
<p>3.  Define the <code class="docutils literal notranslate"><span class="pre">greet()</span></code> function. While the CEL syntax  of <code class="docutils literal notranslate"><span class="pre">i.greet(you)</span></code> looks like a method
of the <code class="docutils literal notranslate"><span class="pre">i</span></code> variable’s class, the function is simply has two positional parameters.</p>
<ol class="arabic simple" start="4">
<li><p>Provide function implementation when creating the final <code class="xref py py-class docutils literal notranslate"><span class="pre">celpy.Runner</span></code> instance.</p></li>
<li><p>Evaluate the program with specific values for the two variables.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">celpy</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cel_source</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="s2">i.greet(you)</span>
<span class="gp">... </span><span class="s2">&quot;&quot;&quot;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">decls</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="n">celpy</span><span class="o">.</span><span class="n">celtypes</span><span class="o">.</span><span class="n">StringType</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s2">&quot;you&quot;</span><span class="p">:</span> <span class="n">celpy</span><span class="o">.</span><span class="n">celtypes</span><span class="o">.</span><span class="n">StringType</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s2">&quot;greet&quot;</span><span class="p">:</span> <span class="n">celpy</span><span class="o">.</span><span class="n">celtypes</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">env</span> <span class="o">=</span> <span class="n">celpy</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">annotations</span><span class="o">=</span><span class="n">decls</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ast</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">cel_source</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span><span class="w"> </span><span class="nf">greet</span><span class="p">(</span><span class="n">lhs</span><span class="p">:</span> <span class="n">celpy</span><span class="o">.</span><span class="n">celtypes</span><span class="o">.</span><span class="n">StringType</span><span class="p">,</span> <span class="n">rhs</span><span class="p">:</span> <span class="n">celpy</span><span class="o">.</span><span class="n">celtypes</span><span class="o">.</span><span class="n">StringType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">celpy</span><span class="o">.</span><span class="n">celtypes</span><span class="o">.</span><span class="n">StringType</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="s2">&quot;Hello </span><span class="si">{1:s}</span><span class="s2">! Nice to meet you, I&#39;m </span><span class="si">{0:s}</span><span class="s2">.</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">prgm</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">program</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">functions</span><span class="o">=</span><span class="p">[</span><span class="n">greet</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="s2">&quot;CEL&quot;</span><span class="p">,</span> <span class="s2">&quot;you&quot;</span><span class="p">:</span> <span class="s2">&quot;world&quot;</span>
<span class="gp">... </span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">prgm</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span>
<span class="go">&quot;Hello world! Nice to meet you, I&#39;m CEL.\\n&quot;</span>
</pre></div>
</div>
<p>The key concept here is to distinguish between three distinct attributes:</p>
<ol class="arabic simple">
<li><p>Type annotations associated with variables or functions.</p></li>
<li><p>The function implementations used to build the <code class="xref py py-class docutils literal notranslate"><span class="pre">celpy.Runner</span></code>.
The method-like syntax of <code class="docutils literal notranslate"><span class="pre">i.greet(you)</span></code> is evaluated as <code class="docutils literal notranslate"><span class="pre">greet(i,</span> <span class="pre">you)</span></code>.</p></li>
<li><p>The variable values, which provide a context in which the runner evaluates the CEL expression.</p></li>
</ol>
<p>This reflects the idea that one CEL expression may be used to process data over and over again.</p>
</section>
<section id="define-custom-global-function">
<h3>Define custom global function<a class="headerlink" href="#define-custom-global-function" title="Link to this heading">¶</a></h3>
<p>In Go, this is a small, but important different.ce
We want to evaluate the expression <code class="docutils literal notranslate"><span class="pre">shake_hands(i,you)</span></code>.
This uses a global function syntax instead of method syntax.</p>
<p>While Go has slight differences in how the function is defined, in Python, there is no change.</p>
<p>Here’s the Python version:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">celpy</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cel_source</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="s2">shake_hands(i,you)</span>
<span class="gp">... </span><span class="s2">&quot;&quot;&quot;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">decls</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="n">celpy</span><span class="o">.</span><span class="n">celtypes</span><span class="o">.</span><span class="n">StringType</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s2">&quot;you&quot;</span><span class="p">:</span> <span class="n">celpy</span><span class="o">.</span><span class="n">celtypes</span><span class="o">.</span><span class="n">StringType</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s2">&quot;shake_hands&quot;</span><span class="p">:</span> <span class="n">celpy</span><span class="o">.</span><span class="n">celtypes</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">env</span> <span class="o">=</span> <span class="n">celpy</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">annotations</span><span class="o">=</span><span class="n">decls</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ast</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">cel_source</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span><span class="w"> </span><span class="nf">shake_hands</span><span class="p">(</span><span class="n">lhs</span><span class="p">:</span> <span class="n">celpy</span><span class="o">.</span><span class="n">celtypes</span><span class="o">.</span><span class="n">StringType</span><span class="p">,</span> <span class="n">rhs</span><span class="p">:</span> <span class="n">celpy</span><span class="o">.</span><span class="n">celtypes</span><span class="o">.</span><span class="n">StringType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">celpy</span><span class="o">.</span><span class="n">celtypes</span><span class="o">.</span><span class="n">StringType</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lhs</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">rhs</span><span class="si">}</span><span class="s2"> are shaking hands.</span><span class="se">\\</span><span class="s2">n&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">prgm</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">program</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">functions</span><span class="o">=</span><span class="p">[</span><span class="n">shake_hands</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="s2">&quot;CEL&quot;</span><span class="p">,</span> <span class="s2">&quot;you&quot;</span><span class="p">:</span> <span class="s2">&quot;world&quot;</span>
<span class="gp">... </span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">prgm</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span>
<span class="go">&#39;CEL and world are shaking hands.\\n&#39;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">shake_hands()</span></code> function is essentially the same as the <code class="docutils literal notranslate"><span class="pre">greet()</span></code> function in the previous example.</p>
<p>For more examples of how to use CEL from Go, see
<a class="reference external" href="https://github.com/google/cel-go/tree/master/cel/cel_test.go">https://github.com/google/cel-go/tree/master/cel/cel_test.go</a></p>
</section>
</section>
<section id="more-examples-from-the-go-implementation">
<h2>More Examples from the Go implementation<a class="headerlink" href="#more-examples-from-the-go-implementation" title="Link to this heading">¶</a></h2>
<p>See <a class="reference external" href="https://github.com/google/cel-go/blob/master/README.md">https://github.com/google/cel-go/blob/master/README.md</a> for five more examples.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Check</span> <span class="n">whether</span> <span class="n">a</span> <span class="n">resource</span> <span class="n">name</span> <span class="n">starts</span> <span class="k">with</span> <span class="n">a</span> <span class="n">group</span> <span class="n">name</span><span class="o">.</span>
<span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s2">&quot;/groups/&quot;</span> <span class="o">+</span> <span class="n">auth</span><span class="o">.</span><span class="n">claims</span><span class="o">.</span><span class="n">group</span><span class="p">)</span>

<span class="o">//</span> <span class="n">Determine</span> <span class="n">whether</span> <span class="n">the</span> <span class="n">request</span> <span class="ow">is</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">permitted</span> <span class="n">time</span> <span class="n">window</span><span class="o">.</span>
<span class="n">request</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">resource</span><span class="o">.</span><span class="n">age</span> <span class="o">&lt;</span> <span class="n">duration</span><span class="p">(</span><span class="s2">&quot;24h&quot;</span><span class="p">)</span>

<span class="o">//</span> <span class="n">Check</span> <span class="n">whether</span> <span class="nb">all</span> <span class="n">resource</span> <span class="n">names</span> <span class="ow">in</span> <span class="n">a</span> <span class="nb">list</span> <span class="n">match</span> <span class="n">a</span> <span class="n">given</span> <span class="nb">filter</span><span class="o">.</span>
<span class="n">auth</span><span class="o">.</span><span class="n">claims</span><span class="o">.</span><span class="n">email_verified</span> <span class="o">&amp;&amp;</span> <span class="n">resources</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">startsWith</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">claims</span><span class="o">.</span><span class="n">email</span><span class="p">))</span>

<span class="o">//</span> <span class="n">Ensure</span> <span class="nb">all</span> <span class="n">tweets</span> <span class="n">are</span> <span class="n">less</span> <span class="n">than</span> <span class="mi">140</span> <span class="n">chars</span>
<span class="n">tweets</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">140</span><span class="p">)</span>

<span class="o">//</span> <span class="n">Test</span> <span class="n">whether</span> <span class="n">the</span> <span class="n">field</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">non</span><span class="o">-</span><span class="n">default</span> <span class="n">value</span> <span class="k">if</span> <span class="n">proto</span><span class="o">-</span><span class="n">based</span><span class="p">,</span> <span class="ow">or</span> <span class="n">defined</span>
<span class="o">//</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">JSON</span> <span class="n">case</span><span class="o">.</span>
<span class="n">has</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">field</span><span class="p">)</span>
</pre></div>
</div>
<p>Here’s the first example, <code class="docutils literal notranslate"><span class="pre">resource.name.startsWith(&quot;/groups/&quot;</span> <span class="pre">+</span> <span class="pre">auth.claims.group)</span></code>.
The Go code is as follows:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;github.com/google/cel-go/cel&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/google/cel-go/checker/decls&quot;</span>
<span class="p">)</span>

<span class="nx">env</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cel</span><span class="p">.</span><span class="nx">NewEnv</span><span class="p">(</span>
<span class="w">    </span><span class="nx">cel</span><span class="p">.</span><span class="nx">Declarations</span><span class="p">(</span>
<span class="w">        </span><span class="nx">decls</span><span class="p">.</span><span class="nx">NewVar</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">decls</span><span class="p">.</span><span class="nx">String</span><span class="p">),</span>
<span class="w">        </span><span class="nx">decls</span><span class="p">.</span><span class="nx">NewVar</span><span class="p">(</span><span class="s">&quot;group&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">decls</span><span class="p">.</span><span class="nx">String</span><span class="p">)))</span>

<span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="nx">issues</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">env</span><span class="p">.</span><span class="nx">Compile</span><span class="p">(</span><span class="s">`name.startsWith(&quot;/groups/&quot; + group)`</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="nx">issues</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">issues</span><span class="p">.</span><span class="nx">Err</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;type-check error: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">issues</span><span class="p">.</span><span class="nx">Err</span><span class="p">())</span>
<span class="p">}</span>
<span class="nx">prg</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">env</span><span class="p">.</span><span class="nx">Program</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;program construction error: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// The `out` var contains the output of a successful evaluation.</span>
<span class="c1">// The `details&#39; var would contain intermediate evaluation state if enabled as</span>
<span class="c1">// a cel.ProgramOption. This can be useful for visualizing how the `out` value</span>
<span class="c1">// was arrive at.</span>
<span class="nx">out</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">prg</span><span class="p">.</span><span class="nx">Eval</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
<span class="w">    </span><span class="s">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/groups/acme.co/documents/secret-stuff&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;group&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;acme.co&quot;</span><span class="p">})</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span><span class="w"> </span><span class="c1">// &#39;true&#39;</span>
</pre></div>
</div>
<p>This has a Python implementation which is substantially similar.
Here’s the Python code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">celpy</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">decls</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">celpy</span><span class="o">.</span><span class="n">celtypes</span><span class="o">.</span><span class="n">StringType</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="n">celpy</span><span class="o">.</span><span class="n">celtypes</span><span class="o">.</span><span class="n">StringType</span><span class="p">,</span>
<span class="gp">... </span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">env</span> <span class="o">=</span> <span class="n">celpy</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">annotations</span><span class="o">=</span><span class="n">decls</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ast</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;name.startsWith(&quot;/groups/&quot; + group)&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">prgm</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">program</span><span class="p">(</span><span class="n">ast</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;/groups/acme.co/documents/secret-stuff&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="s2">&quot;acme.co&quot;</span><span class="p">,</span>
<span class="gp">... </span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">prgm</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span>
<span class="go">BoolType(True)</span>
</pre></div>
</div>
<p>The general outline of compile, create a <code class="xref py py-class docutils literal notranslate"><span class="pre">celpy.Runner</span></code>, and use <code class="xref py py-meth docutils literal notranslate"><span class="pre">celpy.Runner.evaluate()</span></code> to evaluate the CEL expression in a specific context is the central point here.</p>
</section>
<section id="exceptions-and-errors">
<h2>Exceptions and Errors<a class="headerlink" href="#exceptions-and-errors" title="Link to this heading">¶</a></h2>
<p>Exceptions raised in Python world will (eventually) crash the CEL evaluation.
This gives the author of an extension function the complete traceback to help fix the Python code.
No masking or rewriting of Python exceptions ever occurs in extension functions.</p>
<p>A special <code class="xref py py-exc docutils literal notranslate"><span class="pre">celpy.CELEvalError</span></code> exception can be used in an extension function to permit CEL’s short-circuit logic processing to check and ignore an exception.
See the <a class="reference external" href="https://github.com/google/cel-go/blob/master/README.md#partial-state">https://github.com/google/cel-go/blob/master/README.md#partial-state</a> for more examples of how the short-circuit (partial state) operations work.</p>
<p>An extension function can <strong>return</strong> a <code class="xref py py-exc docutils literal notranslate"><span class="pre">celpy.CELEvalError</span></code> object instead of raising it.
This can allow processing to continue in spite of an uncomputable value.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celpy</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_extension</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">Value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">celtypes</span><span class="o">.</span><span class="n">UintType</span><span class="p">(</span><span class="mi">64</span> <span class="o">//</span> <span class="n">a</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">DivideByZeroError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CELEvalError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;my_extension(</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">) error&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The returned exception object allows short-circuit processing.
For example, the CEL expression <code class="docutils literal notranslate"><span class="pre">false</span> <span class="pre">&amp;&amp;</span> <span class="pre">my_extension(0)</span></code> evaluates to <code class="docutils literal notranslate"><span class="pre">false</span></code>.
If computed, any <code class="xref py py-exc docutils literal notranslate"><span class="pre">celpy.CELEvalError</span></code> objects will be silently ignored because the short-circuit result is known from the presence of a <code class="docutils literal notranslate"><span class="pre">false</span></code> value.</p>
<p>On the other hand, the CEL expression <code class="docutils literal notranslate"><span class="pre">true</span> <span class="pre">&amp;&amp;</span> <span class="pre">my_extension(0)</span></code> results in the <code class="xref py py-exc docutils literal notranslate"><span class="pre">celpy.CELEvalError</span></code> result from the extension function.
This will eventually be raised as an exception, so the framework using <code class="docutils literal notranslate"><span class="pre">celpy</span></code> can track this run-time error.</p>
</section>
<section id="cloud-custodian-c7n-integration">
<h2>Cloud Custodian (C7N) Integration<a class="headerlink" href="#cloud-custodian-c7n-integration" title="Link to this heading">¶</a></h2>
<p>Custodian Filters can be evaluated by CEL.
The idea is to extend the YAML-based DSL for policy documents to introduce easier-to-read expressions.</p>
<p>As noted in <a class="reference external" href="https://github.com/cloud-custodian/cloud-custodian/issues/5759">https://github.com/cloud-custodian/cloud-custodian/issues/5759</a>, a filter might look like the
following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">filters</span><span class="p">:</span>
  <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">cel</span>
     <span class="n">expr</span><span class="p">:</span> <span class="o">|</span>
         <span class="n">resource</span><span class="o">.</span><span class="n">creationTimestamp</span> <span class="o">&lt;</span> <span class="n">timestamp</span><span class="p">(</span><span class="s2">&quot;2018-08-03T16:00:00-07:00&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
         <span class="n">resource</span><span class="o">.</span><span class="n">deleteProtection</span> <span class="o">==</span> <span class="n">false</span> <span class="o">&amp;&amp;</span>
         <span class="p">((</span><span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s2">&quot;projects/project-123/zones/us-east1-b/instances/dev&quot;</span><span class="p">)</span> <span class="o">||</span>
         <span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s2">&quot;projects/project-123/zones/us-east1-b/instances/prod&quot;</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
         <span class="n">resource</span><span class="o">.</span><span class="n">instanceSize</span> <span class="o">==</span> <span class="s2">&quot;m1.standard&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This replaces a complex sequence of nested <code class="docutils literal notranslate"><span class="pre">-</span>&#160; <span class="pre">and:</span></code> and <code class="docutils literal notranslate"><span class="pre">-</span>&#160; <span class="pre">or:</span></code> sub-documents with a CEL expression.</p>
<p>C7N processioning works by gathering resources, creating an instance of a subclass of the <code class="docutils literal notranslate"><span class="pre">Filter</span></code> class, and evaluating an expression like <code class="docutils literal notranslate"><span class="pre">take_action</span> <span class="pre">=</span> <span class="pre">list(filter(filter_instance,</span> <span class="pre">resource_list))</span></code>.</p>
<p>The C7N filter expression in a given policy document is composed of one or more atomic filter clauses, combined by <code class="docutils literal notranslate"><span class="pre">and</span></code>, <code class="docutils literal notranslate"><span class="pre">or</span></code>, and <code class="docutils literal notranslate"><span class="pre">not</span></code> operators.
The filter as a whole is handled by the <code class="docutils literal notranslate"><span class="pre">__call__()</span></code> methods of subclasses of the <code class="docutils literal notranslate"><span class="pre">BooleanGroupFilter</span></code> class.</p>
<p>Central to making this work is making the CEL expression into a function that can be applied to the <code class="docutils literal notranslate"><span class="pre">resource</span></code> object.
All CEL versions of a filter will need to have a the following two values in their activations:</p>
<dl class="field-list simple">
<dt class="field-odd">resource<span class="colon">:</span></dt>
<dd class="field-odd"><p>A <code class="xref py py-class docutils literal notranslate"><span class="pre">celtypes.MapType</span></code> document with the resource details.</p>
</dd>
<dt class="field-even">now<span class="colon">:</span></dt>
<dd class="field-even"><p>A <code class="xref py py-class docutils literal notranslate"><span class="pre">celtypes.TimestampType</span></code> object with the current time.</p>
</dd>
</dl>
<section id="baseline-c7n-example">
<h3>Baseline C7N Example<a class="headerlink" href="#baseline-c7n-example" title="Link to this heading">¶</a></h3>
<p>The essence of the integration is to provide a resource description to a function defined as a CEL expression, and receive a boolean result.</p>
<p>Here’s a base example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">celpy</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">env</span> <span class="o">=</span> <span class="n">celpy</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">CEL</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="s2">resource.creationTimestamp &lt; timestamp(&quot;2018-08-03T16:00:00-07:00&quot;) &amp;&amp;</span>
<span class="gp">... </span><span class="s2">resource.deleteProtection == false &amp;&amp;</span>
<span class="gp">... </span><span class="s2">((resource.name.startsWith(</span>
<span class="gp">... </span><span class="s2">      &quot;projects/project-123/zones/us-east1-b/instances/dev&quot;) ||</span>
<span class="gp">... </span><span class="s2">(resource.name.startsWith(</span>
<span class="gp">... </span><span class="s2">      &quot;projects/project-123/zones/us-east1-b/instances/prod&quot;))) &amp;&amp;</span>
<span class="gp">... </span><span class="s2">resource.instanceSize == &quot;m1.standard&quot;)</span>
<span class="gp">... </span><span class="s2">&quot;&quot;&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ast</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">CEL</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">functions</span> <span class="o">=</span> <span class="p">{}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">prgm</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">program</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">functions</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">activation</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s2">&quot;resource&quot;</span><span class="p">:</span>
<span class="gp">... </span>        <span class="n">celpy</span><span class="o">.</span><span class="n">celtypes</span><span class="o">.</span><span class="n">MapType</span><span class="p">({</span>
<span class="gp">... </span>           <span class="s2">&quot;creationTimestamp&quot;</span><span class="p">:</span> <span class="n">celpy</span><span class="o">.</span><span class="n">celtypes</span><span class="o">.</span><span class="n">TimestampType</span><span class="p">(</span><span class="s2">&quot;2018-07-06T05:04:03Z&quot;</span><span class="p">),</span>
<span class="gp">... </span>           <span class="s2">&quot;deleteProtection&quot;</span><span class="p">:</span> <span class="n">celpy</span><span class="o">.</span><span class="n">celtypes</span><span class="o">.</span><span class="n">BoolType</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span>
<span class="gp">... </span>           <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">celpy</span><span class="o">.</span><span class="n">celtypes</span><span class="o">.</span><span class="n">StringType</span><span class="p">(</span><span class="s2">&quot;projects/project-123/zones/us-east1-b/instances/dev/ec2&quot;</span><span class="p">),</span>
<span class="gp">... </span>           <span class="s2">&quot;instanceSize&quot;</span><span class="p">:</span> <span class="n">celpy</span><span class="o">.</span><span class="n">celtypes</span><span class="o">.</span><span class="n">StringType</span><span class="p">(</span><span class="s2">&quot;m1.standard&quot;</span><span class="p">),</span>
<span class="gp">... </span>            <span class="c1"># MORE WOULD GO HERE</span>
<span class="gp">... </span>    <span class="p">})</span>
<span class="gp">... </span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">prgm</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">activation</span><span class="p">)</span>
<span class="go">BoolType(True)</span>
</pre></div>
</div>
<p>In this case, the context contained only one variable, <code class="docutils literal notranslate"><span class="pre">resource</span></code>.
It didn’t require a definition of <code class="docutils literal notranslate"><span class="pre">now</span></code>.</p>
</section>
<section id="bulk-filter-example">
<h3>Bulk Filter Example<a class="headerlink" href="#bulk-filter-example" title="Link to this heading">¶</a></h3>
<p>Pragmatically, C7N works via code somewhat like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resources</span> <span class="o">=</span> <span class="p">[</span><span class="n">provider</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">provider</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">resource_type</span><span class="p">)]</span>
<span class="nb">map</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">cel_program</span><span class="p">,</span> <span class="n">resources</span><span class="p">)))</span>
</pre></div>
</div>
<p>An action is applied to those resources that pass some filter test.
Often, the action disables a resource to prevent data compromise.
The filter looks for items not compliant with policies so they can be deleted or disabled.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">cel_program</span></code> in the above example is an executable CEL program wrapped into a C7N <code class="docutils literal notranslate"><span class="pre">Filter</span></code> subclass.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">celpy</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cel_functions</span> <span class="o">=</span> <span class="p">{}</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span><span class="w"> </span><span class="nc">Filter</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span><span class="w"> </span><span class="nc">CelFilter</span><span class="p">(</span><span class="n">Filter</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">env</span> <span class="o">=</span> <span class="n">celpy</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>
<span class="gp">... </span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">assert</span> <span class="nb">object</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;cel&quot;</span><span class="p">,</span> <span class="s2">&quot;Can&#39;t create CelFilter without filter: - type: </span><span class="se">\&quot;</span><span class="s2">cel</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
<span class="gp">... </span>        <span class="k">assert</span> <span class="s2">&quot;expr&quot;</span> <span class="ow">in</span> <span class="nb">object</span><span class="p">,</span> <span class="s2">&quot;Can&#39;t create CelFilter without filter: - expr: </span><span class="se">\&quot;</span><span class="s2">CEL expression</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
<span class="gp">... </span>        <span class="n">ast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="nb">object</span><span class="p">[</span><span class="s2">&quot;expr&quot;</span><span class="p">])</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">prgm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">program</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">cel_functions</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
<span class="gp">... </span>        <span class="n">activation</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="n">celpy</span><span class="o">.</span><span class="n">json_to_cel</span><span class="p">(</span><span class="n">resource</span><span class="p">),</span> <span class="s2">&quot;now&quot;</span><span class="p">:</span> <span class="n">celpy</span><span class="o">.</span><span class="n">celtypes</span><span class="o">.</span><span class="n">TimestampType</span><span class="p">(</span><span class="n">now</span><span class="p">)}</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prgm</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">activation</span><span class="p">))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">tag_policy</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="gp">... </span>        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;cel&quot;</span><span class="p">,</span>
<span class="gp">... </span>        <span class="s2">&quot;expr&quot;</span><span class="p">:</span> <span class="s2">&quot;! has(resource.tags.owner) || size(resource.tags.owner) == 0&quot;</span>
<span class="gp">... </span>    <span class="p">}</span>
<span class="gp">... </span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">resources</span> <span class="o">=</span> <span class="p">[</span>
<span class="gp">... </span>    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;good&quot;</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="s2">&quot;me&quot;</span><span class="p">}},</span>
<span class="gp">... </span>    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;bad1&quot;</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;not-owner&quot;</span><span class="p">:</span> <span class="s2">&quot;oops&quot;</span><span class="p">}},</span>
<span class="gp">... </span>    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;bad2&quot;</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}},</span>
<span class="gp">... </span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tag_policy_filter</span> <span class="o">=</span> <span class="n">CelFilter</span><span class="p">(</span><span class="n">tag_policy</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">actionable</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">tag_policy_filter</span><span class="p">,</span> <span class="n">resources</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">actionable</span>
<span class="go">[{&#39;name&#39;: &#39;bad1&#39;, &#39;tags&#39;: {&#39;not-owner&#39;: &#39;oops&#39;}}, {&#39;name&#39;: &#39;bad2&#39;, &#39;tags&#39;: {&#39;owner&#39;: None}}]</span>
</pre></div>
</div>
<p>For each resource, the <code class="docutils literal notranslate"><span class="pre">tag_policy_filter</span></code> object applied an internal <code class="docutils literal notranslate"><span class="pre">self.prgm</span></code> to the resource.
The internal <code class="docutils literal notranslate"><span class="pre">self.prgm</span></code> was built from the policy expression, stated in CEL.</p>
</section>
<section id="c7n-filter-and-resource-types">
<h3>C7N Filter and Resource Types<a class="headerlink" href="#c7n-filter-and-resource-types" title="Link to this heading">¶</a></h3>
<p>The <a class="reference internal" href="api.html#module-celpy.c7nlib" title="celpy.c7nlib"><code class="xref py py-mod docutils literal notranslate"><span class="pre">celpy.c7nlib</span></code></a> module provides filter subclasses that include CEL processing.
There are two kinds of C7N filters in use.</p>
<ol class="arabic simple">
<li><p>The <code class="xref py py-mod docutils literal notranslate"><span class="pre">c7n.filters</span></code> package defines about 23 generic filter classes.
These apply to a <code class="docutils literal notranslate"><span class="pre">resource</span></code> object.
Additionally, there’s a library of generic functions used for evaluation.
Generally, the resource definition classes create values in a JSON document.
These values reflect the state of the resource and any closely-related resources.</p></li>
<li><p>The <code class="xref py py-mod docutils literal notranslate"><span class="pre">c7n.resources</span></code> package defines a number of additional resource-specific filters.
These classes can also provide additional resource-specific processing.</p></li>
</ol>
<p>The atomic filter clauses within a policy document have two general forms:</p>
<ul class="simple">
<li><p>Those with “op”. These expose a resource attribute value,
a filter comparison value, and an operator.
For example, <code class="docutils literal notranslate"><span class="pre">resource.creationTimestamp</span> <span class="pre">&lt;</span> <span class="pre">timestamp(&quot;2018-08-03T16:00:00-07:00&quot;)</span></code>.</p></li>
<li><p>Those without “op”. These tests are based on a boolean function embedded in the C7N resource definition class.
For example, <code class="docutils literal notranslate"><span class="pre">!</span> <span class="pre">resource.deleteProtection</span></code> could rely on a attribute with a complex
value computed from one or more resource attribute values.</p></li>
</ul>
<p>The breakdown of <code class="docutils literal notranslate"><span class="pre">filter</span></code> rules in the C7N policy schema has the following counts.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>category</p></th>
<th class="head"><p>count</p></th>
<th class="head"><p>notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>(‘Common’, ‘Op’)</p></td>
<td><p>21</p></td>
<td><p>Used for more than one resource type, exposes resource details to CEL</p></td>
</tr>
<tr class="row-odd"><td><p>(‘Common’, ‘No-Op’)</p></td>
<td><p>15</p></td>
<td><p>Used for more than one resource type, does not expose resource details</p></td>
</tr>
<tr class="row-even"><td><p>(‘Singleton’, ‘Op’)</p></td>
<td><p>27</p></td>
<td><p>Used for exactly one resource type, exposes resource details to CEL</p></td>
</tr>
<tr class="row-odd"><td><p>(‘Singleton’, ‘No-Op’)</p></td>
<td><p>47</p></td>
<td><p>Used for exactly one resource type, does not expose resource details</p></td>
</tr>
</tbody>
</table>
<p>(This is based on cloud-custodian-0.8.40.0, newer versions may have slighyly different numbers.)</p>
</section>
</section>
<section id="external-api">
<h2>External API<a class="headerlink" href="#external-api" title="Link to this heading">¶</a></h2>
<p>The key external components are the following:</p>
<ul>
<li><p><a class="reference internal" href="api.html#celpy.__init__.Environment" title="celpy.__init__.Environment"><code class="xref py py-class docutils literal notranslate"><span class="pre">celpy.__init__.Environment</span></code></a></p>
<p>This has two methods of interest:</p>
<ul class="simple">
<li><p><a class="reference internal" href="api.html#celpy.__init__.Environment.compile" title="celpy.__init__.Environment.compile"><code class="xref py py-meth docutils literal notranslate"><span class="pre">celpy.__init__.Environment.compile()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#celpy.__init__.Environment.program" title="celpy.__init__.Environment.program"><code class="xref py py-meth docutils literal notranslate"><span class="pre">celpy.__init__.Environment.program()</span></code></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="api.html#celpy.__init__.Runner" title="celpy.__init__.Runner"><code class="xref py py-class docutils literal notranslate"><span class="pre">celpy.__init__.Runner</span></code></a></p>
<p>This has one method of interest:</p>
<ul class="simple">
<li><p><a class="reference internal" href="api.html#celpy.__init__.Runner.evaluate" title="celpy.__init__.Runner.evaluate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">celpy.__init__.Runner.evaluate()</span></code></a>.</p></li>
</ul>
</li>
<li><p><a class="reference internal" href="api.html#celpy.adapter.json_to_cel" title="celpy.adapter.json_to_cel"><code class="xref py py-func docutils literal notranslate"><span class="pre">celpy.adapter.json_to_cel()</span></code></a></p>
<p>This is used to convert native Python JSON documents to the appropriate CEL types.</p>
</li>
</ul>
<p class="plantuml">
<img src="_images/plantuml-36fad8472301586150ff18c26187340f47bb62fa.png" alt="&#64;startuml
    class YourApp

    package celpy {
        class Environment {
            compile()
            program()
        }
        abstract class Runner {
            evaluate(context)
        }
        Environment -&gt; Runner

        class CompiledRunner
        class InterpretedRunner

        Runner &lt;|-- CompiledRunner
        Runner &lt;|-- InterpretedRunner
    }

    YourApp *--&gt; Environment : &quot;Creates&quot;

    YourApp *--&gt; Runner : &quot;Evaluates&quot;

&#64;enduml"/>
</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">CEL in Python</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Documentation Content:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">CLI Use of CEL-Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Application Integration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#integration-essentials">Integration Essentials</a></li>
<li class="toctree-l2"><a class="reference internal" href="#function-bindings">Function Bindings</a></li>
<li class="toctree-l2"><a class="reference internal" href="#more-examples-from-the-go-implementation">More Examples from the Go implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#exceptions-and-errors">Exceptions and Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cloud-custodian-c7n-integration">Cloud Custodian (C7N) Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#external-api">External API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="structure.html">Architecture and Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Development Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="c7n_functions.html">C7N Functions Required</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="configuration.html" title="previous chapter">Configuration</a></li>
      <li>Next: <a href="structure.html" title="next chapter">Architecture and Design</a></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2020, CapitalOne.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/integration.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>