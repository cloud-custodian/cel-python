<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>celpy.celtypes &#8212; CEL in Python  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for celpy.celtypes</h1><div class="highlight"><pre>
<span></span><span class="c1"># SPDX-Copyright: Copyright (c) Capital One Services, LLC</span>
<span class="c1"># SPDX-License-Identifier: Apache-2.0</span>
<span class="c1"># Copyright 2020 Capital One Services, LLC</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Provides wrappers over Python types to provide CEL semantics.</span>

<span class="sd">This can be used by a Python module to work with CEL-friendly values and CEL results.</span>

<span class="sd">Examples of distinctions between CEL and Python:</span>

<span class="sd">-   Unlike Python ``bool``, CEL :py:class:`BoolType` won&#39;t do some math.</span>

<span class="sd">-   CEL has ``int64`` and ``uint64`` subclasses of integer. These have specific ranges and</span>
<span class="sd">    raise :exc:`ValueError` errors on overflow.</span>

<span class="sd">CEL types will raise :exc:`ValueError` for out-of-range values and :exc:`TypeError`</span>
<span class="sd">for operations they refuse.</span>
<span class="sd">The :py:mod:`evaluation` module can capture these exceptions and turn them into result values.</span>
<span class="sd">This can permit the logic operators to quietly silence them via &quot;short-circuiting&quot;.</span>

<span class="sd">In the normal course of events, CEL&#39;s evaluator may attempt operations between a</span>
<span class="sd">CEL exception result and an instance of one of CEL types.</span>
<span class="sd">We rely on this leading to an ordinary Python :exc:`TypeError` to be raised to propogate</span>
<span class="sd">the error. Or. A logic operator may discard the error object.</span>

<span class="sd">The :py:mod:`evaluation` module extends these types with it&#39;s own :exc:`CELEvalError` exception.</span>
<span class="sd">We try to keep that as a separate concern from the core operator implementations here.</span>
<span class="sd">We leverage Python features, which means raising exceptions when there is a problem.</span>

<span class="sd">Types</span>
<span class="sd">=============</span>

<span class="sd">See https://github.com/google/cel-go/tree/master/common/types</span>

<span class="sd">These are the Go type definitions that are used by CEL:</span>

<span class="sd">-   BoolType</span>
<span class="sd">-   BytesType</span>
<span class="sd">-   DoubleType</span>
<span class="sd">-   DurationType</span>
<span class="sd">-   IntType</span>
<span class="sd">-   ListType</span>
<span class="sd">-   MapType</span>
<span class="sd">-   NullType</span>
<span class="sd">-   StringType</span>
<span class="sd">-   TimestampType</span>
<span class="sd">-   TypeType</span>
<span class="sd">-   UintType</span>

<span class="sd">The above types are handled directly byt CEL syntax.</span>
<span class="sd">e.g., ``42`` vs. ``42u`` vs. ``&quot;42&quot;`` vs. ``b&quot;42&quot;`` vs. ``42.``.</span>

<span class="sd">We provide matching Python class names for each of these types. The Python type names</span>
<span class="sd">are subclasses of Python native types, allowing a client to transparently work with</span>
<span class="sd">CEL results. A Python host should be able to provide values to CEL that will be tolerated.</span>

<span class="sd">A type hint of ``Value`` unifies these into a common hint.</span>

<span class="sd">The CEL Go implementation also supports protobuf types:</span>

<span class="sd">-   dpb.Duration</span>
<span class="sd">-   tpb.Timestamp</span>
<span class="sd">-   structpb.ListValue</span>
<span class="sd">-   structpb.NullValue</span>
<span class="sd">-   structpb.Struct</span>
<span class="sd">-   structpb.Value</span>
<span class="sd">-   wrapperspb.BoolValue</span>
<span class="sd">-   wrapperspb.BytesValue</span>
<span class="sd">-   wrapperspb.DoubleValue</span>
<span class="sd">-   wrapperspb.FloatValue</span>
<span class="sd">-   wrapperspb.Int32Value</span>
<span class="sd">-   wrapperspb.Int64Value</span>
<span class="sd">-   wrapperspb.StringValue</span>
<span class="sd">-   wrapperspb.UInt32Value</span>
<span class="sd">-   wrapperspb.UInt64Value</span>

<span class="sd">These types involve expressions like the following::</span>

<span class="sd">    google.protobuf.UInt32Value{value: 123u}</span>

<span class="sd">In this case, the well-known protobuf name is directly visible as CEL syntax.</span>
<span class="sd">There&#39;s a ``google`` package with the needed definitions.</span>

<span class="sd">Type Provider</span>
<span class="sd">==============================</span>

<span class="sd">A type provider can be bound to the environment, this will support additional types.</span>
<span class="sd">This appears to be a factory to map names of types to type classes.</span>

<span class="sd">Run-time type binding is shown by a CEL expression like the following::</span>

<span class="sd">    TestAllTypes{single_uint32_wrapper: 432u}</span>

<span class="sd">The ``TestAllTypes`` is a protobuf type added to the CEL run-time. The syntax</span>
<span class="sd">is defined by this syntax rule::</span>

<span class="sd">    member_object  : member &quot;{&quot; [fieldinits] &quot;}&quot;</span>

<span class="sd">The ``member`` is part of a type provider library,</span>
<span class="sd">either a standard protobuf definition or an extension. The field inits build</span>
<span class="sd">values for the protobuf object.</span>

<span class="sd">See https://github.com/google/cel-go/blob/master/test/proto3pb/test_all_types.proto</span>
<span class="sd">for the ``TestAllTypes`` protobuf definition that is registered as a type provider.</span>

<span class="sd">This expression will describes a Protobuf ``uint32`` object.</span>

<span class="sd">Type Adapter</span>
<span class="sd">=============</span>

<span class="sd">So far, it appears that a type adapter wraps existing Go or C++ types</span>
<span class="sd">with CEL-required methods. This seems like it does not need to be implemented</span>
<span class="sd">in Python.</span>

<span class="sd">Numeric Details</span>
<span class="sd">===============</span>

<span class="sd">Integer division truncates toward zero.</span>

<span class="sd">The Go definition of modulus::</span>

<span class="sd">    // Mod returns the floating-point remainder of x/y.</span>
<span class="sd">    // The magnitude of the result is less than y and its</span>
<span class="sd">    // sign agrees with that of x.</span>

<span class="sd">https://golang.org/ref/spec#Arithmetic_operators</span>

<span class="sd">&quot;Go has the nice property that -a/b == -(a/b).&quot;</span>

<span class="sd">::</span>

<span class="sd">     x     y     x / y     x % y</span>
<span class="sd">     5     3       1         2</span>
<span class="sd">    -5     3      -1        -2</span>
<span class="sd">     5    -3      -1         2</span>
<span class="sd">    -5    -3       1        -2</span>

<span class="sd">Python definition::</span>

<span class="sd">    The modulo operator always yields a result</span>
<span class="sd">    with the same sign as its second operand (or zero);</span>
<span class="sd">    the absolute value of the result is strictly smaller than</span>
<span class="sd">    the absolute value of the second operand.</span>

<span class="sd">Here&#39;s the essential rule::</span>

<span class="sd">    x//y * y + x%y == x</span>

<span class="sd">However. Python ``//`` truncates toward negative infinity. Go ``/`` truncates toward zero.</span>

<span class="sd">To get Go-like behavior, we need to use absolute values and restore the signs later.</span>

<span class="sd">::</span>

<span class="sd">    x_sign = -1 if x &lt; 0 else +1</span>
<span class="sd">    go_mod = x_sign * (abs(x) % abs(y))</span>
<span class="sd">    return go_mod</span>

<span class="sd">Timzone Details</span>
<span class="sd">===============</span>

<span class="sd">An implementation may have additional timezone names that must be injected into</span>
<span class="sd">the ``pendulum`` processing. (Formerly ``dateutil.gettz()``.)</span>

<span class="sd">For example, there may be the following sequence:</span>

<span class="sd">1. A lowercase match for an alias or an existing timezone.</span>

<span class="sd">2. A titlecase match for an existing timezone.</span>

<span class="sd">3. The fallback, which is a +/-HH:MM string.</span>

<span class="sd">..  TODO: Permit an extension into the timezone lookup.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">reduce</span><span class="p">,</span> <span class="n">wraps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">fsum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Mapping</span><span class="p">,</span>
    <span class="n">NoReturn</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
    <span class="n">overload</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pendulum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pendulum</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pendulum.tz.exceptions</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;celpy.</span><span class="si">{</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="n">Value</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span>
    <span class="s2">&quot;BoolType&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BytesType&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DoubleType&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DurationType&quot;</span><span class="p">,</span>
    <span class="s2">&quot;IntType&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ListType&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MapType&quot;</span><span class="p">,</span>
    <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Used instead of NullType</span>
    <span class="s2">&quot;StringType&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TimestampType&quot;</span><span class="p">,</span>
    <span class="s2">&quot;UintType&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># The domain of types used to build Annotations.</span>
<span class="n">CELType</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span>
    <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;BoolType&quot;</span><span class="p">],</span>
    <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;BytesType&quot;</span><span class="p">],</span>
    <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;DoubleType&quot;</span><span class="p">],</span>
    <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;DurationType&quot;</span><span class="p">],</span>
    <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;IntType&quot;</span><span class="p">],</span>
    <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;ListType&quot;</span><span class="p">],</span>
    <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;MapType&quot;</span><span class="p">],</span>
    <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>  <span class="c1"># Used instead of NullType</span>
    <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;StringType&quot;</span><span class="p">],</span>
    <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;TimestampType&quot;</span><span class="p">],</span>
    <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;TypeType&quot;</span><span class="p">],</span>  <span class="c1"># Used to mark Protobuf Type values</span>
    <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;UintType&quot;</span><span class="p">],</span>
    <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;PackageType&quot;</span><span class="p">],</span>
    <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;MessageType&quot;</span><span class="p">],</span>
<span class="p">]</span>


<div class="viewcode-block" id="type_matched">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.type_matched">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">type_matched</span><span class="p">(</span><span class="n">method</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorates a method to assure the &quot;other&quot; value has the same type.&quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">type_matching_method</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;no such overload: </span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s2"> </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">other</span><span class="si">!r}</span><span class="s2"> </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">type_matching_method</span></div>



<div class="viewcode-block" id="logical_condition">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.logical_condition">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">logical_condition</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">Value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CEL e ? x : y operator.</span>
<span class="sd">    Choose one of x or y. Exceptions in the unchosen expression are ignored.</span>

<span class="sd">    Example::</span>

<span class="sd">        2 / 0 &gt; 4 ? &#39;baz&#39; : &#39;quux&#39;</span>

<span class="sd">    is a &quot;division by zero&quot; error.</span>

<span class="sd">    ::</span>

<span class="sd">        &gt;&gt;&gt; logical_condition(</span>
<span class="sd">        ... BoolType(True), StringType(&quot;this&quot;), StringType(&quot;Not That&quot;))</span>
<span class="sd">        StringType(&#39;this&#39;)</span>
<span class="sd">        &gt;&gt;&gt; logical_condition(</span>
<span class="sd">        ... BoolType(False), StringType(&quot;Not This&quot;), StringType(&quot;that&quot;))</span>
<span class="sd">        StringType(&#39;that&#39;)</span>

<span class="sd">    .. TODO:: Consider passing closures instead of Values.</span>

<span class="sd">        The function can evaluate e().</span>
<span class="sd">        If it&#39;s True, return x().</span>
<span class="sd">        If it&#39;s False, return y().</span>
<span class="sd">        Otherwise, it&#39;s a CELEvalError, which is the result</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">BoolType</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2"> ? </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">result_value</span> <span class="o">=</span> <span class="n">x</span> <span class="k">if</span> <span class="n">e</span> <span class="k">else</span> <span class="n">y</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;logical_condition(</span><span class="si">%r</span><span class="s2">, </span><span class="si">%r</span><span class="s2">, </span><span class="si">%r</span><span class="s2">) = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">result_value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result_value</span></div>



<div class="viewcode-block" id="logical_and">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.logical_and">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">logical_and</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">Value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Native Python has a left-to-right rule.</span>
<span class="sd">    CEL &amp;&amp; is commutative with non-Boolean values, including error objects.</span>

<span class="sd">    .. TODO:: Consider passing closures instead of Values.</span>

<span class="sd">        The function can evaluate x().</span>
<span class="sd">        If it&#39;s False, then return False.</span>
<span class="sd">        Otherwise, it&#39;s True or a CELEvalError, return y().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">BoolType</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">BoolType</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">x</span><span class="si">!r}</span><span class="s2"> and </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">y</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">BoolType</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">BoolType</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">y</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>  <span class="c1"># whatever &amp;&amp; true == whatever</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span>  <span class="c1"># whatever &amp;&amp; false == false</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">BoolType</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">BoolType</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span>  <span class="c1"># true &amp;&amp; whatever == whatever</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>  <span class="c1"># false &amp;&amp; whatever == false</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">BoolType</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">BoolType</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cast</span><span class="p">(</span><span class="n">BoolType</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span></div>



<div class="viewcode-block" id="logical_not">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.logical_not">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">logical_not</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function for native python `not`.</span>

<span class="sd">    This could almost be `logical_or = evaluation.boolean(operator.not_)`,</span>
<span class="sd">    but the definition would expose Python&#39;s notion of &quot;truthiness&quot;, which isn&#39;t appropriate for CEL.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">BoolType</span><span class="p">):</span>
        <span class="n">result_value</span> <span class="o">=</span> <span class="n">BoolType</span><span class="p">(</span><span class="ow">not</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;logical_not(</span><span class="si">%r</span><span class="s2">) = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">result_value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result_value</span></div>



<div class="viewcode-block" id="logical_or">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.logical_or">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">logical_or</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">Value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Native Python has a left-to-right rule: ``(True or y)`` is True, ``(False or y)`` is y.</span>
<span class="sd">    CEL ``||`` is commutative with non-Boolean values, including errors.</span>
<span class="sd">    ``(x || false)`` is ``x``, and ``(false || y)`` is ``y``.</span>

<span class="sd">    Example 1::</span>

<span class="sd">        false || 1/0 != 0</span>

<span class="sd">    is a &quot;no matching overload&quot; error.</span>

<span class="sd">    Example 2::</span>

<span class="sd">        (2 / 0 &gt; 3 ? false : true) || true</span>

<span class="sd">    is a &quot;True&quot;</span>

<span class="sd">    If the operand(s) are not ``BoolType``, we&#39;ll create an ``TypeError`` that will become a ``CELEvalError``.</span>

<span class="sd">    .. TODO:: Consider passing closures instead of Values.</span>

<span class="sd">        The function can evaluate x().</span>
<span class="sd">        If it&#39;s True, then return True.</span>
<span class="sd">        Otherwise, it&#39;s False or a CELEvalError, return y().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">BoolType</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">BoolType</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">x</span><span class="si">!r}</span><span class="s2"> or </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">y</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">BoolType</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">BoolType</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">y</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span>  <span class="c1"># whatever || true == true</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>  <span class="c1"># whatever || false == whatever</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">BoolType</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">BoolType</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>  <span class="c1"># true || whatever == true</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span>  <span class="c1"># false || whatever == whatever</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">BoolType</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">BoolType</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cast</span><span class="p">(</span><span class="n">BoolType</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span></div>



<div class="viewcode-block" id="BoolType">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.BoolType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BoolType</span><span class="p">(</span><span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Native Python permits all unary operators to work on ``bool`` objects.</span>

<span class="sd">    For CEL, we need to prevent the CEL expression ``-false`` from working.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="BoolType.__new__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.BoolType.__new__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;BoolType&quot;</span><span class="p">],</span> <span class="n">source</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;BoolType&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">BoolType</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">source</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">MessageType</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">StringType</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">))))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span></div>


<div class="viewcode-block" id="BoolType.__repr__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.BoolType.__repr__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="BoolType.__str__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.BoolType.__str__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>


<div class="viewcode-block" id="BoolType.__neg__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.BoolType.__neg__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;no such overload&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BoolType.__hash__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.BoolType.__hash__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__hash__</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="BytesType">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.BytesType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BytesType</span><span class="p">(</span><span class="nb">bytes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Python&#39;s bytes semantics are close to CEL.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="BytesType.__new__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.BytesType.__new__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;BytesType&quot;</span><span class="p">],</span>
        <span class="n">source</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="s2">&quot;BytesType&quot;</span><span class="p">,</span> <span class="s2">&quot;StringType&quot;</span><span class="p">],</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;BytesType&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">BytesType</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">StringType</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">MessageType</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span>
                <span class="bp">cls</span><span class="p">,</span>
                <span class="n">cast</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">StringType</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">))),</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">source</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid initial value type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BytesType.__repr__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.BytesType.__repr__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="BytesType.contains">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.BytesType.contains">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BoolType</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">BoolType</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">BytesType</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>  <span class="c1"># type: ignore [comparison-overlap]</span></div>
</div>



<div class="viewcode-block" id="DoubleType">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DoubleType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DoubleType</span><span class="p">(</span><span class="nb">float</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Native Python permits mixed type comparisons, doing conversions as needed.</span>

<span class="sd">    For CEL, we need to prevent mixed-type comparisons from working.</span>

<span class="sd">    TODO: Conversions from string? IntType? UintType? DoubleType?</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DoubleType.__new__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DoubleType.__new__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;DoubleType&quot;</span><span class="p">],</span> <span class="n">source</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DoubleType&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">MessageType</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">StringType</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">))))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span></div>


<div class="viewcode-block" id="DoubleType.__repr__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DoubleType.__repr__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="DoubleType.__str__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DoubleType.__str__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">text</span></div>


<div class="viewcode-block" id="DoubleType.__neg__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DoubleType.__neg__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DoubleType&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DoubleType</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__neg__</span><span class="p">())</span></div>


<div class="viewcode-block" id="DoubleType.__mod__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DoubleType.__mod__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__mod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;found no matching overload for &#39;_%_&#39; applied to &#39;(double, </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="si">}</span><span class="s2">)&#39;&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="DoubleType.__truediv__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DoubleType.__truediv__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DoubleType&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DoubleType</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DoubleType</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__truediv__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span></div>


<div class="viewcode-block" id="DoubleType.__rmod__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DoubleType.__rmod__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__rmod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;found no matching overload for &#39;_%_&#39; applied to &#39;(</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="si">}</span><span class="s2">, double)&#39;&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="DoubleType.__rtruediv__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DoubleType.__rtruediv__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__rtruediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DoubleType&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DoubleType</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DoubleType</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__rtruediv__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span></div>


<div class="viewcode-block" id="DoubleType.__eq__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DoubleType.__eq__">[docs]</a>
    <span class="nd">@type_matched</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></div>


<div class="viewcode-block" id="DoubleType.__ne__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DoubleType.__ne__">[docs]</a>
    <span class="nd">@type_matched</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__ne__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></div>


<div class="viewcode-block" id="DoubleType.__hash__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DoubleType.__hash__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__hash__</span><span class="p">()</span></div>
</div>



<span class="n">IntOperator</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;IntOperator&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span>


<div class="viewcode-block" id="int64">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.int64">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">int64</span><span class="p">(</span><span class="n">operator</span><span class="p">:</span> <span class="n">IntOperator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntOperator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply an operation, but assure the value is within the int64 range.&quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">operator</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">clamped_operator</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">result_value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">operator</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="o">-</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">63</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">result_value</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">63</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result_value</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;overflow&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">IntOperator</span><span class="p">,</span> <span class="n">clamped_operator</span><span class="p">)</span></div>



<div class="viewcode-block" id="IntType">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">IntType</span><span class="p">(</span><span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A version of int with overflow errors outside int64 range.</span>

<span class="sd">    features/integer_math.feature:277  &quot;int64_overflow_positive&quot;</span>

<span class="sd">    &gt;&gt;&gt; IntType(9223372036854775807) + IntType(1)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    ValueError: overflow</span>

<span class="sd">    &gt;&gt;&gt; 2**63</span>
<span class="sd">    9223372036854775808</span>

<span class="sd">    features/integer_math.feature:285  &quot;int64_overflow_negative&quot;</span>

<span class="sd">    &gt;&gt;&gt; -IntType(9223372036854775808) - IntType(1)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    ValueError: overflow</span>

<span class="sd">    &gt;&gt;&gt; IntType(DoubleType(1.9))</span>
<span class="sd">    IntType(2)</span>
<span class="sd">    &gt;&gt;&gt; IntType(DoubleType(-123.456))</span>
<span class="sd">    IntType(-123)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="IntType.__new__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType.__new__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;IntType&quot;</span><span class="p">],</span> <span class="n">source</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IntType&quot;</span><span class="p">:</span>
        <span class="n">convert</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">IntType</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">source</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">MessageType</span><span class="p">):</span>
            <span class="c1"># Used by protobuf.</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">StringType</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">))))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">)):</span>
            <span class="n">convert</span> <span class="o">=</span> <span class="n">int64</span><span class="p">(</span><span class="nb">round</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">TimestampType</span><span class="p">):</span>
            <span class="n">convert</span> <span class="o">=</span> <span class="n">int64</span><span class="p">(</span><span class="k">lambda</span> <span class="n">src</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">StringType</span><span class="p">))</span> <span class="ow">and</span> <span class="n">source</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;0x&quot;</span><span class="p">,</span> <span class="s2">&quot;0X&quot;</span><span class="p">}:</span>
            <span class="n">convert</span> <span class="o">=</span> <span class="n">int64</span><span class="p">(</span><span class="k">lambda</span> <span class="n">src</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="mi">16</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">StringType</span><span class="p">))</span> <span class="ow">and</span> <span class="n">source</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;-0x&quot;</span><span class="p">,</span> <span class="s2">&quot;-0X&quot;</span><span class="p">}:</span>
            <span class="n">convert</span> <span class="o">=</span> <span class="n">int64</span><span class="p">(</span><span class="k">lambda</span> <span class="n">src</span><span class="p">:</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="mi">16</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Must tolerate &quot;-&quot; as part of the literal.</span>
            <span class="c1"># See https://github.com/google/cel-spec/issues/126</span>
            <span class="n">convert</span> <span class="o">=</span> <span class="n">int64</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">convert</span><span class="p">(</span><span class="n">source</span><span class="p">))</span></div>


<div class="viewcode-block" id="IntType.__repr__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType.__repr__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="IntType.__str__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType.__str__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">text</span></div>


<div class="viewcode-block" id="IntType.__neg__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType.__neg__">[docs]</a>
    <span class="nd">@int64</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IntType&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__neg__</span><span class="p">())</span></div>


<div class="viewcode-block" id="IntType.__add__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType.__add__">[docs]</a>
    <span class="nd">@int64</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IntType&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">IntType</span><span class="p">,</span> <span class="n">other</span><span class="p">)))</span></div>


<div class="viewcode-block" id="IntType.__sub__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType.__sub__">[docs]</a>
    <span class="nd">@int64</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IntType&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__sub__</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">IntType</span><span class="p">,</span> <span class="n">other</span><span class="p">)))</span></div>


<div class="viewcode-block" id="IntType.__mul__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType.__mul__">[docs]</a>
    <span class="nd">@int64</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IntType&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__mul__</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">IntType</span><span class="p">,</span> <span class="n">other</span><span class="p">)))</span></div>


<div class="viewcode-block" id="IntType.__truediv__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType.__truediv__">[docs]</a>
    <span class="nd">@int64</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IntType&quot;</span><span class="p">:</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">IntType</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="n">self_sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span> <span class="o">&lt;</span> <span class="n">IntType</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">other_sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">other</span> <span class="o">&lt;</span> <span class="n">IntType</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">go_div</span> <span class="o">=</span> <span class="n">self_sign</span> <span class="o">*</span> <span class="n">other_sign</span> <span class="o">*</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">//</span> <span class="nb">abs</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="n">go_div</span><span class="p">)</span></div>


    <span class="fm">__floordiv__</span> <span class="o">=</span> <span class="fm">__truediv__</span>

<div class="viewcode-block" id="IntType.__mod__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType.__mod__">[docs]</a>
    <span class="nd">@int64</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__mod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IntType&quot;</span><span class="p">:</span>
        <span class="n">self_sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span> <span class="o">&lt;</span> <span class="n">IntType</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">go_mod</span> <span class="o">=</span> <span class="n">self_sign</span> <span class="o">*</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">IntType</span><span class="p">,</span> <span class="n">other</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="n">go_mod</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntType.__radd__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType.__radd__">[docs]</a>
    <span class="nd">@int64</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IntType&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__radd__</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">IntType</span><span class="p">,</span> <span class="n">other</span><span class="p">)))</span></div>


<div class="viewcode-block" id="IntType.__rsub__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType.__rsub__">[docs]</a>
    <span class="nd">@int64</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__rsub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IntType&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__rsub__</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">IntType</span><span class="p">,</span> <span class="n">other</span><span class="p">)))</span></div>


<div class="viewcode-block" id="IntType.__rmul__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType.__rmul__">[docs]</a>
    <span class="nd">@int64</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IntType&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__rmul__</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">IntType</span><span class="p">,</span> <span class="n">other</span><span class="p">)))</span></div>


<div class="viewcode-block" id="IntType.__rtruediv__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType.__rtruediv__">[docs]</a>
    <span class="nd">@int64</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__rtruediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IntType&quot;</span><span class="p">:</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">IntType</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="n">self_sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span> <span class="o">&lt;</span> <span class="n">IntType</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">other_sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">other</span> <span class="o">&lt;</span> <span class="n">IntType</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">go_div</span> <span class="o">=</span> <span class="n">self_sign</span> <span class="o">*</span> <span class="n">other_sign</span> <span class="o">*</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">//</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="n">go_div</span><span class="p">)</span></div>


    <span class="fm">__rfloordiv__</span> <span class="o">=</span> <span class="fm">__rtruediv__</span>

<div class="viewcode-block" id="IntType.__rmod__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType.__rmod__">[docs]</a>
    <span class="nd">@int64</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__rmod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IntType&quot;</span><span class="p">:</span>
        <span class="n">left_sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">other</span> <span class="o">&lt;</span> <span class="n">IntType</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">go_mod</span> <span class="o">=</span> <span class="n">left_sign</span> <span class="o">*</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="n">go_mod</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntType.__eq__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType.__eq__">[docs]</a>
    <span class="nd">@type_matched</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntType.__ne__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType.__ne__">[docs]</a>
    <span class="nd">@type_matched</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__ne__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntType.__lt__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType.__lt__">[docs]</a>
    <span class="nd">@type_matched</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__lt__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntType.__le__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType.__le__">[docs]</a>
    <span class="nd">@type_matched</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__le__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntType.__gt__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType.__gt__">[docs]</a>
    <span class="nd">@type_matched</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__gt__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntType.__ge__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType.__ge__">[docs]</a>
    <span class="nd">@type_matched</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__ge__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntType.__hash__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.IntType.__hash__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__hash__</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="uint64">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.uint64">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">uint64</span><span class="p">(</span><span class="n">operator</span><span class="p">:</span> <span class="n">IntOperator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntOperator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply an operation, but assure the value is within the uint64 range.&quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">operator</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">clamped_operator</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">result_value</span> <span class="o">=</span> <span class="n">operator</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">result_value</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">64</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result_value</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;overflow&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">IntOperator</span><span class="p">,</span> <span class="n">clamped_operator</span><span class="p">)</span></div>



<div class="viewcode-block" id="UintType">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.UintType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">UintType</span><span class="p">(</span><span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A version of int with overflow errors outside uint64 range.</span>

<span class="sd">    Alternatives:</span>

<span class="sd">        Option 1 - Use https://pypi.org/project/fixedint/</span>

<span class="sd">        Option 2 - use array or struct modules to access an unsigned object.</span>

<span class="sd">    Test Cases:</span>

<span class="sd">    features/integer_math.feature:149  &quot;unary_minus_no_overload&quot;</span>

<span class="sd">    &gt;&gt;&gt; -UintType(42)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    TypeError: no such overload</span>

<span class="sd">    uint64_overflow_positive</span>

<span class="sd">    &gt;&gt;&gt; UintType(18446744073709551615) + UintType(1)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    ValueError: overflow</span>

<span class="sd">    uint64_overflow_negative</span>

<span class="sd">    &gt;&gt;&gt; UintType(0) - UintType(1)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    ValueError: overflow</span>

<span class="sd">    &gt;&gt;&gt; - UintType(5)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    TypeError: no such overload</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="UintType.__new__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.UintType.__new__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;UintType&quot;</span><span class="p">],</span> <span class="n">source</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;UintType&quot;</span><span class="p">:</span>
        <span class="n">convert</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">UintType</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">source</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">)):</span>
            <span class="n">convert</span> <span class="o">=</span> <span class="n">uint64</span><span class="p">(</span><span class="nb">round</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">TimestampType</span><span class="p">):</span>
            <span class="n">convert</span> <span class="o">=</span> <span class="n">uint64</span><span class="p">(</span><span class="k">lambda</span> <span class="n">src</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">StringType</span><span class="p">))</span> <span class="ow">and</span> <span class="n">source</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;0x&quot;</span><span class="p">,</span> <span class="s2">&quot;0X&quot;</span><span class="p">}:</span>
            <span class="n">convert</span> <span class="o">=</span> <span class="n">uint64</span><span class="p">(</span><span class="k">lambda</span> <span class="n">src</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="mi">16</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">MessageType</span><span class="p">):</span>
            <span class="c1"># Used by protobuf.</span>
            <span class="n">convert</span> <span class="o">=</span> <span class="n">uint64</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">src</span><span class="p">:</span> <span class="n">src</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">src</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">convert</span> <span class="o">=</span> <span class="n">uint64</span><span class="p">(</span><span class="k">lambda</span> <span class="n">src</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">convert</span> <span class="o">=</span> <span class="n">uint64</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">convert</span><span class="p">(</span><span class="n">source</span><span class="p">))</span></div>


<div class="viewcode-block" id="UintType.__repr__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.UintType.__repr__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="UintType.__str__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.UintType.__str__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">text</span></div>


<div class="viewcode-block" id="UintType.__neg__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.UintType.__neg__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;no such overload&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="UintType.__add__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.UintType.__add__">[docs]</a>
    <span class="nd">@uint64</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;UintType&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">UintType</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">IntType</span><span class="p">,</span> <span class="n">other</span><span class="p">)))</span></div>


<div class="viewcode-block" id="UintType.__sub__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.UintType.__sub__">[docs]</a>
    <span class="nd">@uint64</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;UintType&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">UintType</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__sub__</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">IntType</span><span class="p">,</span> <span class="n">other</span><span class="p">)))</span></div>


<div class="viewcode-block" id="UintType.__mul__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.UintType.__mul__">[docs]</a>
    <span class="nd">@uint64</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;UintType&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">UintType</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__mul__</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">IntType</span><span class="p">,</span> <span class="n">other</span><span class="p">)))</span></div>


<div class="viewcode-block" id="UintType.__truediv__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.UintType.__truediv__">[docs]</a>
    <span class="nd">@uint64</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;UintType&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">UintType</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__floordiv__</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">IntType</span><span class="p">,</span> <span class="n">other</span><span class="p">)))</span></div>


    <span class="fm">__floordiv__</span> <span class="o">=</span> <span class="fm">__truediv__</span>

<div class="viewcode-block" id="UintType.__mod__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.UintType.__mod__">[docs]</a>
    <span class="nd">@uint64</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__mod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;UintType&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">UintType</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__mod__</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">IntType</span><span class="p">,</span> <span class="n">other</span><span class="p">)))</span></div>


<div class="viewcode-block" id="UintType.__radd__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.UintType.__radd__">[docs]</a>
    <span class="nd">@uint64</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;UintType&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">UintType</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__radd__</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">IntType</span><span class="p">,</span> <span class="n">other</span><span class="p">)))</span></div>


<div class="viewcode-block" id="UintType.__rsub__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.UintType.__rsub__">[docs]</a>
    <span class="nd">@uint64</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__rsub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;UintType&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">UintType</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__rsub__</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">IntType</span><span class="p">,</span> <span class="n">other</span><span class="p">)))</span></div>


<div class="viewcode-block" id="UintType.__rmul__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.UintType.__rmul__">[docs]</a>
    <span class="nd">@uint64</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;UintType&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">UintType</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__rmul__</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">IntType</span><span class="p">,</span> <span class="n">other</span><span class="p">)))</span></div>


<div class="viewcode-block" id="UintType.__rtruediv__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.UintType.__rtruediv__">[docs]</a>
    <span class="nd">@uint64</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__rtruediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;UintType&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">UintType</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__rfloordiv__</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">IntType</span><span class="p">,</span> <span class="n">other</span><span class="p">)))</span></div>


    <span class="fm">__rfloordiv__</span> <span class="o">=</span> <span class="fm">__rtruediv__</span>

<div class="viewcode-block" id="UintType.__rmod__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.UintType.__rmod__">[docs]</a>
    <span class="nd">@uint64</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__rmod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;UintType&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">UintType</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__rmod__</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">IntType</span><span class="p">,</span> <span class="n">other</span><span class="p">)))</span></div>


<div class="viewcode-block" id="UintType.__eq__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.UintType.__eq__">[docs]</a>
    <span class="nd">@type_matched</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></div>


<div class="viewcode-block" id="UintType.__ne__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.UintType.__ne__">[docs]</a>
    <span class="nd">@type_matched</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__ne__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></div>


<div class="viewcode-block" id="UintType.__hash__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.UintType.__hash__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__hash__</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="ListType">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.ListType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ListType</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">Value</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Native Python implements comparison operations between list objects.</span>

<span class="sd">    For CEL, we prevent list comparison operators from working.</span>

<span class="sd">    We provide an :py:meth:`__eq__` and :py:meth:`__ne__` that</span>
<span class="sd">    gracefully ignore type mismatch problems, calling them not equal.</span>

<span class="sd">    See https://github.com/google/cel-spec/issues/127</span>

<span class="sd">    An implied logical And means a singleton behaves in a distinct way from a non-singleton list.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ListType.__repr__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.ListType.__repr__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="ListType.__lt__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.ListType.__lt__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;no such overload&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ListType.__le__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.ListType.__le__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;no such overload&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ListType.__gt__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.ListType.__gt__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;no such overload&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ListType.__ge__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.ListType.__ge__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;no such overload&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ListType.__eq__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.ListType.__eq__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">ListType</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no such overload: ListType == </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">equal</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">o</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">BoolType</span><span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">o</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">BoolType</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>  <span class="c1"># Instead of Union[BoolType, TypeError]</span>

        <span class="n">result_value</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="n">reduce</span><span class="p">(</span>
            <span class="n">logical_and</span><span class="p">,</span>  <span class="c1"># type: ignore [arg-type]</span>
            <span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">item_s</span><span class="p">,</span> <span class="n">item_o</span><span class="p">)</span> <span class="k">for</span> <span class="n">item_s</span><span class="p">,</span> <span class="n">item_o</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)),</span>
            <span class="n">BoolType</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_value</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">result_value</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result_value</span><span class="p">)</span></div>


<div class="viewcode-block" id="ListType.__ne__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.ListType.__ne__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">ListType</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no such overload: ListType != </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">not_equal</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">o</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">BoolType</span><span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="n">o</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">BoolType</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>  <span class="c1"># Instead of Union[BoolType, TypeError]</span>

        <span class="n">result_value</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">or</span> <span class="n">reduce</span><span class="p">(</span>
            <span class="n">logical_or</span><span class="p">,</span>  <span class="c1"># type: ignore [arg-type]</span>
            <span class="p">(</span><span class="n">not_equal</span><span class="p">(</span><span class="n">item_s</span><span class="p">,</span> <span class="n">item_o</span><span class="p">)</span> <span class="k">for</span> <span class="n">item_s</span><span class="p">,</span> <span class="n">item_o</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)),</span>
            <span class="n">BoolType</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_value</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">result_value</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result_value</span><span class="p">)</span></div>


<div class="viewcode-block" id="ListType.contains">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.ListType.contains">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BoolType</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">BoolType</span><span class="p">(</span><span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span></div>
</div>



<span class="n">BaseMapTypes</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="kc">None</span><span class="p">]</span>


<span class="n">MapKeyTypes</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;IntType&quot;</span><span class="p">,</span> <span class="s2">&quot;UintType&quot;</span><span class="p">,</span> <span class="s2">&quot;BoolType&quot;</span><span class="p">,</span> <span class="s2">&quot;StringType&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>


<div class="viewcode-block" id="MapType">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.MapType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MapType</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="n">Value</span><span class="p">,</span> <span class="n">Value</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Native Python allows mapping updates and any hashable type as a kay.</span>

<span class="sd">    CEL prevents mapping updates and has a limited domain of key types.</span>
<span class="sd">        int, uint, bool, or string keys</span>

<span class="sd">    We provide an :py:meth:`__eq__` and :py:meth:`__ne__` that</span>
<span class="sd">    gracefully ignore type mismatch problems for the values, calling them not equal.</span>

<span class="sd">    See https://github.com/google/cel-spec/issues/127</span>

<span class="sd">    An implied logical And means a singleton behaves in a distinct way from a non-singleton mapping.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MapType.__init__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.MapType.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="n">BaseMapTypes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
            <span class="c1"># Must Be Unique</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Duplicate key </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid initial value type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">items</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MapType.__repr__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.MapType.__repr__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="MapType.__getitem__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.MapType.__getitem__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">MapType</span><span class="o">.</span><span class="n">valid_key_type</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unsupported key type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>


<div class="viewcode-block" id="MapType.__eq__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.MapType.__eq__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">Mapping</span><span class="p">,</span> <span class="n">MapType</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no such overload: MapType == </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">equal</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">o</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BoolType</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">BoolType</span><span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">o</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">BoolType</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>  <span class="c1"># Instead of Union[BoolType, TypeError]</span>

        <span class="n">keys_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">keys_o</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">result_value</span> <span class="o">=</span> <span class="n">keys_s</span> <span class="o">==</span> <span class="n">keys_o</span> <span class="ow">and</span> <span class="n">reduce</span><span class="p">(</span>
            <span class="n">logical_and</span><span class="p">,</span>  <span class="c1"># type: ignore [arg-type]</span>
            <span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">other</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys_s</span><span class="p">),</span>
            <span class="n">BoolType</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_value</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">result_value</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result_value</span><span class="p">)</span></div>


<div class="viewcode-block" id="MapType.__ne__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.MapType.__ne__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">Mapping</span><span class="p">,</span> <span class="n">MapType</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no such overload: MapType != </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Singleton special case, may return no-such overload.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">k</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span>
                <span class="nb">bool</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="n">other</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="p">)</span>  <span class="c1"># Instead of Union[BoolType, TypeError]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">not_equal</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">o</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BoolType</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">BoolType</span><span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="n">o</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">BoolType</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>  <span class="c1"># Instead of Union[BoolType, TypeError]</span>

        <span class="n">keys_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">keys_o</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">result_value</span> <span class="o">=</span> <span class="n">keys_s</span> <span class="o">!=</span> <span class="n">keys_o</span> <span class="ow">or</span> <span class="n">reduce</span><span class="p">(</span>
            <span class="n">logical_or</span><span class="p">,</span>  <span class="c1"># type: ignore [arg-type]</span>
            <span class="p">(</span><span class="n">not_equal</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">other</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys_s</span><span class="p">),</span>
            <span class="n">BoolType</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_value</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">result_value</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result_value</span><span class="p">)</span></div>


<div class="viewcode-block" id="MapType.get">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.MapType.get">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;There is no default provision in CEL, that&#39;s a Python feature.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">MapType</span><span class="o">.</span><span class="n">valid_key_type</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unsupported key type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Value</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>


<div class="viewcode-block" id="MapType.valid_key_type">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.MapType.valid_key_type">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">valid_key_type</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Valid CEL key types. Plus native str for tokens in the source when evaluating ``e.f``&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">IntType</span><span class="p">,</span> <span class="n">UintType</span><span class="p">,</span> <span class="n">BoolType</span><span class="p">,</span> <span class="n">StringType</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span></div>


<div class="viewcode-block" id="MapType.contains">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.MapType.contains">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BoolType</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">BoolType</span><span class="p">(</span><span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="NullType">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.NullType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NullType</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Python&#39;s None semantics aren&#39;t quite right for CEL.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="NullType.__eq__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.NullType.__eq__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">NullType</span><span class="p">)</span></div>


<div class="viewcode-block" id="NullType.__ne__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.NullType.__ne__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">NullType</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="StringType">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.StringType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">StringType</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Python&#39;s str semantics are very, very close to CEL.</span>

<span class="sd">    We rely on the overlap between ``&quot;/u270c&quot;`` and ``&quot;/U0001f431&quot;`` in CEL and Python.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="StringType.__new__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.StringType.__new__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;StringType&quot;</span><span class="p">],</span>
        <span class="n">source</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="s2">&quot;BytesType&quot;</span><span class="p">,</span> <span class="s2">&quot;StringType&quot;</span><span class="p">],</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StringType&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">BytesType</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf&quot;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">StringType</span><span class="p">)):</span>
            <span class="c1"># TODO: Consider returning the original StringType object.</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">StringType</span><span class="p">,</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source</span><span class="p">))</span></div>


<div class="viewcode-block" id="StringType.__repr__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.StringType.__repr__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="StringType.__eq__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.StringType.__eq__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></div>


<div class="viewcode-block" id="StringType.__ne__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.StringType.__ne__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__ne__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></div>


<div class="viewcode-block" id="StringType.__hash__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.StringType.__hash__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__hash__</span><span class="p">()</span></div>


<div class="viewcode-block" id="StringType.contains">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.StringType.contains">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BoolType</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">BoolType</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">StringType</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TimestampType">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TimestampType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TimestampType</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements google.protobuf.Timestamp</span>

<span class="sd">    See https://developers.google.com/protocol-buffers/docs/reference/google.protobuf</span>

<span class="sd">    Also see https://www.ietf.org/rfc/rfc3339.txt.</span>

<span class="sd">    The protobuf implementation is an ordered pair of int64 seconds and int32 nanos.</span>

<span class="sd">    Instead of a Tuple[int, int] we use a wrapper for :py:class:`datetime.datetime`.</span>

<span class="sd">    From protobuf documentation for making a Timestamp in Python::</span>

<span class="sd">        now = time.time()</span>
<span class="sd">        seconds = int(now)</span>
<span class="sd">        nanos = int((now - seconds) * 10**9)</span>
<span class="sd">        timestamp = Timestamp(seconds=seconds, nanos=nanos)</span>

<span class="sd">    Also::</span>

<span class="sd">        &gt;&gt;&gt; t = TimestampType(&quot;2009-02-13T23:31:30Z&quot;)</span>
<span class="sd">        &gt;&gt;&gt; repr(t)</span>
<span class="sd">        &quot;TimestampType(&#39;2009-02-13T23:31:30Z&#39;)&quot;</span>
<span class="sd">        &gt;&gt;&gt; t.timestamp()</span>
<span class="sd">        1234567890.0</span>
<span class="sd">        &gt;&gt;&gt; str(t)</span>
<span class="sd">        &#39;2009-02-13T23:31:30Z&#39;</span>

<span class="sd">    :strong:`Timezones`</span>

<span class="sd">    Timezones are expressed in the following grammar:</span>

<span class="sd">    ::</span>

<span class="sd">        TimeZone = &quot;UTC&quot; | LongTZ | FixedTZ ;</span>
<span class="sd">        LongTZ = ? list available at</span>
<span class="sd">                   http://joda-time.sourceforge.net/timezones.html ? ;</span>
<span class="sd">        FixedTZ = ( &quot;+&quot; | &quot;-&quot; ) Digit Digit &quot;:&quot; Digit Digit ;</span>
<span class="sd">        Digit = &quot;0&quot; | &quot;1&quot; | ... | &quot;9&quot; ;</span>

<span class="sd">    Fixed timezones are explicit hour and minute offsets from UTC.</span>
<span class="sd">    Long timezone names are like Europe/Paris, CET, or US/Central.</span>

<span class="sd">    The Joda project (https://www.joda.org/joda-time/timezones.html)</span>
<span class="sd">    says &quot;Time zone data is provided by the public IANA time zone database.&quot;</span>

<span class="sd">    TZ handling and timestamp parsing is doine with</span>
<span class="sd">    the ``pendulum`` (https://pendulum.eustace.io) project.</span>

<span class="sd">    Additionally, there is a ``TZ_ALIASES`` mapping available in this class to permit additional</span>
<span class="sd">    timezone names. By default, the mapping is empty, and the only names</span>
<span class="sd">    available are those recognized by :mod:`pendulum.timezone`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">TZ_ALIASES</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="TimestampType.__new__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TimestampType.__new__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;TimestampType&quot;</span><span class="p">],</span>
        <span class="n">source</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">],</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;TimestampType&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="c1"># Wrap a datetime.datetime</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span>
                <span class="bp">cls</span><span class="p">,</span>
                <span class="n">year</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                <span class="n">month</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                <span class="n">day</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                <span class="n">hour</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
                <span class="n">minute</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span>
                <span class="n">second</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="n">microsecond</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">microsecond</span><span class="p">,</span>
                <span class="n">tzinfo</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">or</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># Wrap a sequence of integers that datetime.datetime might accept.</span>
            <span class="n">ts</span><span class="p">:</span> <span class="n">TimestampType</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ts</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ts</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Use ``pendulum`` to try a variety of text formats.</span>
            <span class="n">parsed_datetime</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">pendulum</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span>
                <span class="bp">cls</span><span class="p">,</span>
                <span class="n">year</span><span class="o">=</span><span class="n">parsed_datetime</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                <span class="n">month</span><span class="o">=</span><span class="n">parsed_datetime</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                <span class="n">day</span><span class="o">=</span><span class="n">parsed_datetime</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                <span class="n">hour</span><span class="o">=</span><span class="n">parsed_datetime</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
                <span class="n">minute</span><span class="o">=</span><span class="n">parsed_datetime</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span>
                <span class="n">second</span><span class="o">=</span><span class="n">parsed_datetime</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="n">microsecond</span><span class="o">=</span><span class="n">parsed_datetime</span><span class="o">.</span><span class="n">microsecond</span><span class="p">,</span>
                <span class="n">tzinfo</span><span class="o">=</span><span class="n">parsed_datetime</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot create </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">source</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TimestampType.__repr__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TimestampType.__repr__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">!r}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="TimestampType.__str__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TimestampType.__str__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S%z&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;+0000&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">text</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">Z&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">text</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">text</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="TimestampType.__add__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TimestampType.__add__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;TimestampType&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Timestamp + Duration -&gt; Timestamp&quot;&quot;&quot;</span>
        <span class="n">result_value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result_value</span> <span class="o">==</span> <span class="bp">NotImplemented</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="k">return</span> <span class="n">TimestampType</span><span class="p">(</span><span class="n">result_value</span><span class="p">)</span></div>


<div class="viewcode-block" id="TimestampType.__radd__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TimestampType.__radd__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;TimestampType&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Duration + Timestamp -&gt; Timestamp&quot;&quot;&quot;</span>
        <span class="n">result_value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__radd__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result_value</span> <span class="o">==</span> <span class="bp">NotImplemented</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="k">return</span> <span class="n">TimestampType</span><span class="p">(</span><span class="n">result_value</span><span class="p">)</span></div>


    <span class="c1"># For more information, check the typeshed definition</span>
    <span class="c1"># https://github.com/python/typeshed/blob/master/stdlib/2and3/datetime.pyi</span>

    <span class="nd">@overload</span>  <span class="c1"># type: ignore</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;TimestampType&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DurationType&quot;</span><span class="p">:</span> <span class="o">...</span>  <span class="c1"># pragma: no cover</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;DurationType&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;TimestampType&quot;</span><span class="p">:</span> <span class="o">...</span>  <span class="c1"># pragma: no cover</span>

<div class="viewcode-block" id="TimestampType.__sub__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TimestampType.__sub__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__sub__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;TimestampType&quot;</span><span class="p">,</span> <span class="s2">&quot;DurationType&quot;</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;TimestampType&quot;</span><span class="p">,</span> <span class="s2">&quot;DurationType&quot;</span><span class="p">]:</span>
        <span class="n">result_value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__sub__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result_value</span> <span class="o">==</span> <span class="bp">NotImplemented</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">DurationType</span><span class="p">,</span> <span class="n">result_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">DurationType</span><span class="p">(</span><span class="n">result_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TimestampType</span><span class="p">(</span><span class="n">result_value</span><span class="p">)</span></div>


<div class="viewcode-block" id="TimestampType.tz_name_lookup">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TimestampType.tz_name_lookup">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tz_name_lookup</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tz_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The ``pendulum`` parsing may be extended with additional aliases.</span>

<span class="sd">        ..  TODO: Permit an extension into the timezone lookup.</span>
<span class="sd">            Tweak ``celpy.celtypes.TimestampType.TZ_ALIASES``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tz_lookup</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tz_name</span><span class="p">)</span>
        <span class="n">tz</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tz_lookup</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TZ_ALIASES</span><span class="p">:</span>
            <span class="n">tz</span> <span class="o">=</span> <span class="n">timezone</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">TZ_ALIASES</span><span class="p">[</span><span class="n">tz_lookup</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tz</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">,</span> <span class="n">timezone</span><span class="p">(</span><span class="n">tz_lookup</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">pendulum</span><span class="o">.</span><span class="n">tz</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">InvalidTimezone</span><span class="p">:</span>
                <span class="c1"># hh:mm format...</span>
                <span class="n">tz</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">tz_offset_parse</span><span class="p">(</span><span class="n">tz_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tz</span></div>


<div class="viewcode-block" id="TimestampType.tz_offset_parse">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TimestampType.tz_offset_parse">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tz_offset_parse</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tz_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">]:</span>
        <span class="n">tz_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^([+-]?)(\d\d?):(\d\d)$&quot;</span><span class="p">)</span>
        <span class="n">tz_match</span> <span class="o">=</span> <span class="n">tz_pat</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">tz_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tz_match</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unparsable timezone: </span><span class="si">{</span><span class="n">tz_name</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sign</span><span class="p">,</span> <span class="n">hh</span><span class="p">,</span> <span class="n">mm</span> <span class="o">=</span> <span class="n">tz_match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
        <span class="n">offset_min</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">mm</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">sign</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span> <span class="k">else</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">offset_min</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">tz</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tz</span></div>


<div class="viewcode-block" id="TimestampType.tz_parse">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TimestampType.tz_parse">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tz_parse</span><span class="p">(</span><span class="n">tz_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">tz_name</span><span class="p">:</span>
            <span class="n">tz</span> <span class="o">=</span> <span class="n">TimestampType</span><span class="o">.</span><span class="n">tz_name_lookup</span><span class="p">(</span><span class="n">tz_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tz</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">timezone</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TimestampType.getDate">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TimestampType.getDate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getDate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tz_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StringType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntType</span><span class="p">:</span>
        <span class="n">new_tz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tz_parse</span><span class="p">(</span><span class="n">tz_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">new_tz</span><span class="p">)</span><span class="o">.</span><span class="n">day</span><span class="p">)</span></div>


<div class="viewcode-block" id="TimestampType.getDayOfMonth">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TimestampType.getDayOfMonth">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getDayOfMonth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tz_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StringType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntType</span><span class="p">:</span>
        <span class="n">new_tz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tz_parse</span><span class="p">(</span><span class="n">tz_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">new_tz</span><span class="p">)</span><span class="o">.</span><span class="n">day</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="TimestampType.getDayOfWeek">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TimestampType.getDayOfWeek">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getDayOfWeek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tz_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StringType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntType</span><span class="p">:</span>
        <span class="n">new_tz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tz_parse</span><span class="p">(</span><span class="n">tz_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">new_tz</span><span class="p">)</span><span class="o">.</span><span class="n">isoweekday</span><span class="p">()</span> <span class="o">%</span> <span class="mi">7</span><span class="p">)</span></div>


<div class="viewcode-block" id="TimestampType.getDayOfYear">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TimestampType.getDayOfYear">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getDayOfYear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tz_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StringType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntType</span><span class="p">:</span>
        <span class="n">new_tz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tz_parse</span><span class="p">(</span><span class="n">tz_name</span><span class="p">)</span>
        <span class="n">working_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">new_tz</span><span class="p">)</span>
        <span class="n">jan1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">working_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">new_tz</span><span class="p">)</span>
        <span class="n">days</span> <span class="o">=</span> <span class="n">working_date</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span> <span class="o">-</span> <span class="n">jan1</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="n">days</span><span class="p">)</span></div>


<div class="viewcode-block" id="TimestampType.getMonth">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TimestampType.getMonth">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getMonth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tz_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StringType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntType</span><span class="p">:</span>
        <span class="n">new_tz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tz_parse</span><span class="p">(</span><span class="n">tz_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">new_tz</span><span class="p">)</span><span class="o">.</span><span class="n">month</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="TimestampType.getFullYear">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TimestampType.getFullYear">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getFullYear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tz_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StringType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntType</span><span class="p">:</span>
        <span class="n">new_tz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tz_parse</span><span class="p">(</span><span class="n">tz_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">new_tz</span><span class="p">)</span><span class="o">.</span><span class="n">year</span><span class="p">)</span></div>


<div class="viewcode-block" id="TimestampType.getHours">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TimestampType.getHours">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getHours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tz_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StringType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntType</span><span class="p">:</span>
        <span class="n">new_tz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tz_parse</span><span class="p">(</span><span class="n">tz_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">new_tz</span><span class="p">)</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span></div>


<div class="viewcode-block" id="TimestampType.getMilliseconds">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TimestampType.getMilliseconds">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getMilliseconds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tz_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StringType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntType</span><span class="p">:</span>
        <span class="n">new_tz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tz_parse</span><span class="p">(</span><span class="n">tz_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">new_tz</span><span class="p">)</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">//</span> <span class="mi">1000</span><span class="p">)</span></div>


<div class="viewcode-block" id="TimestampType.getMinutes">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TimestampType.getMinutes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getMinutes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tz_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StringType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntType</span><span class="p">:</span>
        <span class="n">new_tz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tz_parse</span><span class="p">(</span><span class="n">tz_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">new_tz</span><span class="p">)</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span></div>


<div class="viewcode-block" id="TimestampType.getSeconds">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TimestampType.getSeconds">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getSeconds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tz_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StringType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntType</span><span class="p">:</span>
        <span class="n">new_tz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tz_parse</span><span class="p">(</span><span class="n">tz_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">new_tz</span><span class="p">)</span><span class="o">.</span><span class="n">second</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="DurationType">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DurationType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DurationType</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements google.protobuf.Duration</span>

<span class="sd">    https://developers.google.com/protocol-buffers/docs/reference/google.protobuf#duration</span>

<span class="sd">    The protobuf implementation is an ordered pair of int64 seconds and int32 nanos.</span>
<span class="sd">    Instead of a Tuple[int, int] we use a wrapper for :py:class:`datetime.timedelta`.</span>

<span class="sd">    The definition once said this::</span>

<span class="sd">        &quot;type conversion, duration should be end with &quot;s&quot;, which stands for seconds&quot;</span>

<span class="sd">    This is obsolete, however, considering the following issue.</span>

<span class="sd">    See https://github.com/google/cel-spec/issues/138</span>

<span class="sd">    This refers to the following implementation detail</span>
<span class="sd">    ::</span>

<span class="sd">        // A duration string is a possibly signed sequence of</span>
<span class="sd">        // decimal numbers, each with optional fraction and a unit suffix,</span>
<span class="sd">        // such as &quot;300ms&quot;, &quot;-1.5h&quot; or &quot;2h45m&quot;.</span>
<span class="sd">        // Valid time units are &quot;ns&quot;, &quot;us&quot; (or &quot;s&quot;), &quot;ms&quot;, &quot;s&quot;, &quot;m&quot;, &quot;h&quot;.</span>

<span class="sd">    The real regex, then is this::</span>

<span class="sd">        [-+]?([0-9]*(\\.[0-9]*)?[a-z]+)+</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">MaxSeconds</span> <span class="o">=</span> <span class="mi">315576000000</span>
    <span class="n">MinSeconds</span> <span class="o">=</span> <span class="o">-</span><span class="mi">315576000000</span>
    <span class="n">NanosecondsPerSecond</span> <span class="o">=</span> <span class="mi">1000000000</span>

    <span class="n">scale</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ns&quot;</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span>
        <span class="s2">&quot;us&quot;</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span>
        <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span>
        <span class="s2">&quot;ms&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
        <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mf">24.0</span> <span class="o">*</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="mf">60.0</span><span class="p">,</span>
    <span class="p">}</span>

<div class="viewcode-block" id="DurationType.__new__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DurationType.__new__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;DurationType&quot;</span><span class="p">],</span> <span class="n">seconds</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">nanos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DurationType&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">MinSeconds</span> <span class="o">&lt;=</span> <span class="n">seconds</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">MaxSeconds</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;range error: </span><span class="si">{seconds}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span>
                <span class="bp">cls</span><span class="p">,</span>
                <span class="n">days</span><span class="o">=</span><span class="n">seconds</span><span class="o">.</span><span class="n">days</span><span class="p">,</span>
                <span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="o">.</span><span class="n">seconds</span><span class="p">,</span>
                <span class="n">microseconds</span><span class="o">=</span><span class="n">seconds</span><span class="o">.</span><span class="n">microseconds</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">MinSeconds</span> <span class="o">&lt;=</span> <span class="n">seconds</span> <span class="o">&lt;=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">MaxSeconds</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;range error: </span><span class="si">{seconds}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="p">,</span> <span class="n">microseconds</span><span class="o">=</span><span class="n">nanos</span> <span class="o">//</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">duration_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[-+]?([0-9]*(\.[0-9]*)?[a-z]+)+$&quot;</span><span class="p">)</span>

            <span class="n">duration_match</span> <span class="o">=</span> <span class="n">duration_pat</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">duration_match</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid duration </span><span class="si">{</span><span class="n">seconds</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Consume the sign.</span>
            <span class="n">sign</span><span class="p">:</span> <span class="nb">float</span>
            <span class="k">if</span> <span class="n">seconds</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">):</span>
                <span class="n">seconds</span> <span class="o">=</span> <span class="n">seconds</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="n">seconds</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                <span class="n">seconds</span> <span class="o">=</span> <span class="n">seconds</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>

            <span class="c1"># Sum the remaining time components: number * unit</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">seconds</span> <span class="o">=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">fsum</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">n_u</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">n_u</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="n">n_u</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;([0-9]*(\.[0-9]*)?)([a-z]+)&quot;</span><span class="p">,</span> <span class="n">seconds</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid duration </span><span class="si">{</span><span class="n">seconds</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">MinSeconds</span> <span class="o">&lt;=</span> <span class="n">seconds</span> <span class="o">&lt;=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">MaxSeconds</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;range error: </span><span class="si">{seconds}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid initial value type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DurationType.__repr__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DurationType.__repr__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">!r}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="DurationType.__str__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DurationType.__str__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span></div>


<div class="viewcode-block" id="DurationType.__add__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DurationType.__add__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DurationType&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This doesn&#39;t need to handle the rich variety of TimestampType overloadds.</span>
<span class="sd">        This class only needs to handle results of duration + duration.</span>
<span class="sd">        A duration + timestamp is not implemented by the timedelta superclass;</span>
<span class="sd">        it is handled by the datetime superclass that implementes timestamp + duration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result_value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result_value</span> <span class="o">==</span> <span class="bp">NotImplemented</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">DurationType</span><span class="p">,</span> <span class="n">result_value</span><span class="p">)</span>
        <span class="c1"># This is handled by TimestampType; this is here for completeness, but isn&#39;t used.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_value</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">TimestampType</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">TimestampType</span><span class="p">(</span><span class="n">result_value</span><span class="p">)</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">return</span> <span class="n">DurationType</span><span class="p">(</span><span class="n">result_value</span><span class="p">)</span></div>


<div class="viewcode-block" id="DurationType.__radd__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DurationType.__radd__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DurationType&quot;</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This doesn&#39;t need to handle the rich variety of TimestampType overloadds.</span>

<span class="sd">        Most cases are handled by TimeStamp.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result_value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__radd__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result_value</span> <span class="o">==</span> <span class="bp">NotImplemented</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">DurationType</span><span class="p">,</span> <span class="n">result_value</span><span class="p">)</span>
        <span class="c1"># This is handled by TimestampType; this is here for completeness, but isn&#39;t used.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_value</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">TimestampType</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">TimestampType</span><span class="p">(</span><span class="n">result_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DurationType</span><span class="p">(</span><span class="n">result_value</span><span class="p">)</span></div>


<div class="viewcode-block" id="DurationType.getHours">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DurationType.getHours">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getHours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tz_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntType</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">tz_name</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">/</span> <span class="mi">60</span><span class="p">))</span></div>


<div class="viewcode-block" id="DurationType.getMilliseconds">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DurationType.getMilliseconds">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getMilliseconds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tz_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntType</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">tz_name</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span></div>


<div class="viewcode-block" id="DurationType.getMinutes">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DurationType.getMinutes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getMinutes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tz_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntType</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">tz_name</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span><span class="p">))</span></div>


<div class="viewcode-block" id="DurationType.getSeconds">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.DurationType.getSeconds">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getSeconds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tz_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntType</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">tz_name</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">IntType</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span></div>
</div>



<div class="viewcode-block" id="FunctionType">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.FunctionType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FunctionType</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    We need a concrete Annotation object to describe callables to celpy.</span>
<span class="sd">    We need to describe functions as well as callable objects.</span>
<span class="sd">    The description would tend to shadow ``typing.Callable``.</span>

<span class="sd">    An ``__isinstance__()`` method, for example, may be helpful for run-time type-checking.</span>

<span class="sd">    Superclass for CEL extension functions that are defined at run-time.</span>
<span class="sd">    This permits a formal annotation in the environment construction that creates</span>
<span class="sd">    an intended type for a given name.</span>

<span class="sd">    This allows for some run-time type checking to see if the actual object binding</span>
<span class="sd">    matches the declared type binding.</span>

<span class="sd">    Also used to define protobuf classes provided as an annotation.</span>

<span class="sd">    We *could* define this as three overloads to cover unary, binary, and tertiary cases.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FunctionType.__call__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.FunctionType.__call__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>
</div>



<div class="viewcode-block" id="PackageType">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.PackageType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PackageType</span><span class="p">(</span><span class="n">MapType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A package of message types, usually protobuf.</span>

<span class="sd">    TODO: This may not be needed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span></div>



<div class="viewcode-block" id="MessageType">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.MessageType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MessageType</span><span class="p">(</span><span class="n">MapType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An individual protobuf message definition. A mapping from field name to field value.</span>

<span class="sd">    See Scenario: &quot;message_literal&quot; in the parse.feature. This is a very deeply-nested</span>
<span class="sd">    message (30? levels), but the navigation to &quot;payload&quot; field seems to create a default</span>
<span class="sd">    value at the top level.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MessageType.__init__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.MessageType.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span> <span class="o">**</span><span class="n">fields</span><span class="p">:</span> <span class="n">Value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">Mapping</span><span class="p">[</span><span class="n">Value</span><span class="p">,</span> <span class="n">Value</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">args</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Expected dictionary or fields, not </span><span class="si">{args!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">({</span><span class="n">StringType</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span></div>
</div>



<div class="viewcode-block" id="TypeType">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TypeType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TypeType</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is primarily used as a function to extract type from an object or a type.</span>
<span class="sd">    For consistence, we define it as a type so other types can extend it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TypeType.__new__">
<a class="viewcode-back" href="../../api.html#celpy.celtypes.TypeType.__new__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">typ</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">CEL in Python</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Documentation Content:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">CLI Use of CEL-Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../integration.html">Application Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../structure.html">Architecture and Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development.html">Development Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../c7n_functions.html">C7N Functions Required</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2020, CapitalOne.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>